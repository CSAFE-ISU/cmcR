---
title: "Cartridge Case Reproducible Example"
output: rmarkdown::html_vignette
vignette: >
%\VignetteIndexEntry{Cartridge Case Reproducible Example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  ---
  
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
  
```{r setup}
library(cmcR)
```

Select breech face impressions selecting raw values around the RANSAC fitted plane.

```{r}
km1_nonResiduals <- selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-1.x3p",
                                       ransacIters = 400,
                                       useResiduals = FALSE)
km2_nonResiduals <- selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-2.x3p",
                                       ransacIters = 400,
                                       useResiduals = FALSE)
unknown1_nonResiduals <- selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul F.x3p",
                                            ransacIters = 400,
                                            useResiduals = FALSE)
unknown2_nonResiduals <- selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_2/cc/Fadul 2-1.x3p",
                                            ransacIters = 400,
                                            useResiduals = FALSE)
```

```{r}
imager::imlist(imager::as.cimg(km1_nonResiduals$x3p$surface.matrix),
               imager::as.cimg(km2_nonResiduals$x3p$surface.matrix),
               imager::as.cimg(unknown1_nonResiduals$x3p$surface.matrix),
               imager::as.cimg(unknown2_nonResiduals$x3p$surface.matrix)) %>%
  plot()
```

```{r}
km1Unknown1CCF <- cellCCF_bothDirections(x3p1 = km1_nonResiduals$x3p,
                                         x3p2 = unknown1_nonResiduals$x3p,
                                         thetas = seq(-30,30,by = 3),
                                         cellNumHoriz = 8,
                                         cellNumVert = 8,
                                         centerCell = "wholeMatrix")

km1Unknown2CCF <- cellCCF_bothDirections(x3p1 = km1_nonResiduals$x3p,
                                         x3p2 = unknown2_nonResiduals$x3p,
                                         thetas = seq(-30,30,by = 3),
                                         cellNumHoriz = 8,
                                         cellNumVert = 8,
                                         centerCell = "wholeMatrix")

km2Unknown1CCF <- cellCCF_bothDirections(x3p1 = km2_nonResiduals$x3p,
                                         x3p2 = unknown1_nonResiduals$x3p,
                                         thetas = seq(-30,30,by = 3),
                                         cellNumHoriz = 8,
                                         cellNumVert = 8,
                                         centerCell = "wholeMatrix")

km2Unknown2CCF <- cellCCF_bothDirections(x3p1 = km2_nonResiduals$x3p,
                                         x3p2 = unknown2_nonResiduals$x3p,
                                         thetas = seq(-30,30,by = 3),
                                         cellNumHoriz = 8,
                                         cellNumVert = 8,
                                         centerCell = "wholeMatrix")
```

```{r}
km1Unknown1CMCs <- cmcFilter_improved(km1Unknown1CCF,
                                      consensus_function = median,
                                      ccf_thresh = .4,
                                      dx_thresh = 20,
                                      theta_thresh = 3,
                                      consensus_function_theta = getMode)

km1Unknown2CMCs <- cmcFilter_improved(km1Unknown2CCF,
                                      consensus_function = median,
                                      ccf_thresh = .4,
                                      dx_thresh = 20,
                                      theta_thresh = 3,
                                      consensus_function_theta = getMode)

km2Unknown1CMCs <- cmcFilter_improved(km2Unknown1CCF,
                                      consensus_function = median,
                                      ccf_thresh = .4,
                                      dx_thresh = 20,
                                      theta_thresh = 3,
                                      consensus_function_theta = getMode)

km2Unknown2CMCs <- cmcFilter_improved(km2Unknown2CCF,
                                      consensus_function = median,
                                      ccf_thresh = .4,
                                      dx_thresh = 20,
                                      theta_thresh = 3,
                                      consensus_function_theta = getMode)

km1Unknown1CMCs$finalCMCs
km1Unknown2CMCs$finalCMCs
km2Unknown1CMCs$finalCMCs
km2Unknown2CMCs$finalCMCs
```

Select breech face impressions selecting the residuals between the RANSAC fitted plane and raw values.

```{r}
km1_Residuals <- selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-1.x3p",
                                    ransacIters = 400,
                                    useResiduals = TRUE)
km2_Residuals <- selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-2.x3p",
                                    ransacIters = 400,
                                    useResiduals = TRUE)
unknown1_Residuals <- selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul F.x3p",
                                         ransacIters = 400,
                                         useResiduals = TRUE)
unknown2_Residuals <- selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_2/cc/Fadul 2-1.x3p",
                                         ransacIters = 400,
                                         useResiduals = TRUE)
```


```{r}
imager::imlist(imager::as.cimg(km1_Residuals$x3p$surface.matrix),
               imager::as.cimg(km2_Residuals$x3p$surface.matrix),
               imager::as.cimg(unknown1_Residuals$x3p$surface.matrix),
               imager::as.cimg(unknown2_Residuals$x3p$surface.matrix)) %>%
  plot()
```

```{r}
km1Unknown1CCF <- cellCCF_bothDirections(x3p1 = km1_Residuals$x3p,
                                         x3p2 = unknown1_Residuals$x3p,
                                         thetas = seq(-30,30,by = 3),
                                         cellNumHoriz = 8,
                                         cellNumVert = 8,
                                         centerCell = "wholeMatrix")

km1Unknown2CCF <- cellCCF_bothDirections(x3p1 = km1_Residuals$x3p,
                                         x3p2 = unknown2_Residuals$x3p,
                                         thetas = seq(-30,30,by = 3),
                                         cellNumHoriz = 8,
                                         cellNumVert = 8,
                                         centerCell = "wholeMatrix")

km2Unknown1CCF <- cellCCF_bothDirections(x3p1 = km2_Residuals$x3p,
                                         x3p2 = unknown1_Residuals$x3p,
                                         thetas = seq(-30,30,by = 3),
                                         cellNumHoriz = 8,
                                         cellNumVert = 8,
                                         centerCell = "wholeMatrix")

km2Unknown2CCF <- cellCCF_bothDirections(x3p1 = km2_Residuals$x3p,
                                         x3p2 = unknown2_Residuals$x3p,
                                         thetas = seq(-30,30,by = 3),
                                         cellNumHoriz = 8,
                                         cellNumVert = 8,
                                         centerCell = "wholeMatrix")
```

```{r}
km1Unknown1CMCs <- cmcFilter_improved(km1Unknown1CCF,
                                      consensus_function = median,
                                      ccf_thresh = .4,
                                      dx_thresh = 20,
                                      theta_thresh = 3,
                                      consensus_function_theta = median)

km1Unknown2CMCs <- cmcFilter_improved(km1Unknown2CCF,
                                      consensus_function = median,
                                      ccf_thresh = .4,
                                      dx_thresh = 20,
                                      theta_thresh = 3,
                                      consensus_function_theta = median)

km2Unknown1CMCs <- cmcFilter_improved(km2Unknown1CCF,
                                      consensus_function = median,
                                      ccf_thresh = .4,
                                      dx_thresh = 20,
                                      theta_thresh = 3,
                                      consensus_function_theta = median)

km2Unknown2CMCs <- cmcFilter_improved(km2Unknown2CCF,
                                      consensus_function = median,
                                      ccf_thresh = .4,
                                      dx_thresh = 20,
                                      theta_thresh = 3,
                                      consensus_function_theta = median)

km1Unknown1CMCs$finalCMCs
km1Unknown2CMCs$finalCMCs
km2Unknown1CMCs$finalCMCs
km2Unknown2CMCs$finalCMCs
```

