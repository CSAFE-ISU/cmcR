---
title: "Cartridge Case Reproducible Example"
output: rmarkdown::html_vignette
vignette: >
%\VignetteIndexEntry{Cartridge Case Reproducible Example}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  ---
  
  ```{r, include = FALSE}
  knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
  )
  ```
  
```{r setup}
  library(cmcR)
  library(magrittr)
```

Select breech face impressions selecting raw values around the RANSAC fitted plane.

```{r}
km1_residuals <- x3ptools::read_x3p(file = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-1.x3p")

km2_residuals <- x3ptools::read_x3p(file = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-2.x3p")
```

```{r}
km1_residuals %>%
  # x3ptools::sample_x3p() %>%
  .$surface.matrix %>%
  imager::as.cimg() %>%
  as.data.frame() %>%
  ggplot2::ggplot(ggplot2::aes(x = x,y = y)) +
  ggplot2::geom_raster(ggplot2::aes(fill = value)) +
  ggplot2::scale_fill_gradient2(low = "grey0",
                                mid = "grey50",
                                high = "grey100",
                                na.value = "white",
                                midpoint = median(as.vector(km1_residuals$surface.matrix),na.rm = TRUE)) +
  ggplot2::coord_fixed(expand = FALSE) +
  ggplot2::theme_bw() +
  ggplot2::theme(panel.grid.major = ggplot2::element_blank(),
                 panel.grid.minor = ggplot2::element_blank(),
                 legend.position = "none",
                 axis.title.x = ggplot2::element_blank(),
                 axis.title.y = ggplot2::element_blank())

km2_residuals$surface.matrix %>%
  # multiply_by(10^5) %>%
  imager::as.cimg() %>%
  as.data.frame() %>%
  ggplot2::ggplot(ggplot2::aes(x = x,y = y)) +
  ggplot2::geom_raster(ggplot2::aes(fill = value)) +
  ggplot2::scale_fill_gradient2(low = "grey0",
                                mid = "grey50",
                                high = "grey100",
                                na.value = "white",
                                midpoint = median(as.vector(km2_residuals$surface.matrix),na.rm = TRUE)) +
  ggplot2::coord_fixed(expand = FALSE) +
  ggplot2::theme_bw() +
  ggplot2::theme(panel.grid.major = ggplot2::element_blank(),
                 panel.grid.minor = ggplot2::element_blank(),
                 legend.position = "none",
                 axis.title.x = ggplot2::element_blank(),
                 axis.title.y = ggplot2::element_blank())
```


```{r}
km1_residuals$surface.matrix <- km1_residuals$surface.matrix %>%
  cmcR::preProcess_ransac() %>%
  cmcR::preProcess_levelBF(useResiduals = TRUE)
```

```{r}
km1_residuals$surface.matrix %>%
  multiply_by(10^5) %>%
  imager::as.cimg() %>%
  as.data.frame() %>%
  ggplot2::ggplot(ggplot2::aes(x = x,y = y)) +
  ggplot2::geom_raster(ggplot2::aes(fill = value)) +
  ggplot2::scale_fill_gradient2(low = "grey0",
                                mid = "grey50",
                                high = "grey100",
                                na.value = "white") +
  ggplot2::coord_fixed(expand = FALSE) +
  ggplot2::theme_bw() +
  ggplot2::theme(panel.grid.major = ggplot2::element_blank(),
                 panel.grid.minor = ggplot2::element_blank(),
                 legend.position = "none",
                 axis.title.x = ggplot2::element_blank(),
                 axis.title.y = ggplot2::element_blank())

# km2_residuals$surface.matrix %>%
#   multiply_by(10^5) %>%
#   imager::as.cimg() %>%
#   as.data.frame() %>%
#   ggplot2::ggplot(ggplot2::aes(x = x,y = y)) +
#   ggplot2::geom_raster(ggplot2::aes(fill = value)) +
#   ggplot2::scale_fill_gradient2(low = "grey0",
#                                 mid = "grey50",
#                                 high = "grey100",
#                                 na.value = "white") +
#   ggplot2::coord_fixed(expand = FALSE) +
#   ggplot2::theme_bw() +
#   ggplot2::theme(panel.grid.major = ggplot2::element_blank(),
#                  panel.grid.minor = ggplot2::element_blank(),
#                  legend.position = "none",
#                  axis.title.x = ggplot2::element_blank(),
#                  axis.title.y = ggplot2::element_blank())
```

```{r}
matFake <- matrix(NA,nrow = nrow(km1_residuals$surface.matrix),ncol = ncol(km1_residuals$surface.matrix))

matFake[(nrow(km1_residuals$surface.matrix)/2 - .1*nrow(km1_residuals$surface.matrix)):
                         (nrow(km1_residuals$surface.matrix)/2 + .1*nrow(km1_residuals$surface.matrix)),] <- km1_residuals$surface.matrix[(nrow(km1_residuals$surface.matrix)/2 - .1*nrow(km1_residuals$surface.matrix)):
                         (nrow(km1_residuals$surface.matrix)/2 + .1*nrow(km1_residuals$surface.matrix)),]

matFake[,(ncol(km1_residuals$surface.matrix)/2 - .1*ncol(km1_residuals$surface.matrix)):
          (ncol(km1_residuals$surface.matrix)/2 + .1*ncol(km1_residuals$surface.matrix))] <- km1_residuals$surface.matrix[,(ncol(km1_residuals$surface.matrix)/2 - .1*ncol(km1_residuals$surface.matrix)):
                                                                                                                            (ncol(km1_residuals$surface.matrix)/2 + .1*ncol(km1_residuals$surface.matrix))]


matFake %>%
  imager::as.cimg() %>%
  as.data.frame() %>%
  ggplot2::ggplot(ggplot2::aes(x = x,y = y)) +
  ggplot2::geom_raster(ggplot2::aes(fill = value)) +
  ggplot2::scale_fill_gradient2(low = "grey0",
                                mid = "grey50",
                                high = "grey100",
                                na.value = "white") +
  ggplot2::coord_fixed(expand = FALSE) +
  ggplot2::theme_bw() +
  ggplot2::theme(panel.grid.major = ggplot2::element_blank(),
                 panel.grid.minor = ggplot2::element_blank(),
                 legend.position = "none",
                 axis.title.x = ggplot2::element_blank(),
                 axis.title.y = ggplot2::element_blank())
```


```{r}
km1_residuals$surface.matrix <- cmcR::preProcess_removeFPCircle(surfaceMat = km1_residuals$surface.matrix)
```

```{r}
km1_residuals$surface.matrix %>%
  multiply_by(10^5) %>%
  imager::as.cimg() %>%
  as.data.frame() %>%
  ggplot2::ggplot(ggplot2::aes(x = x,y = y)) +
  ggplot2::geom_raster(ggplot2::aes(fill = value)) +
  ggplot2::scale_fill_gradient2(low = "grey0",
                                mid = "grey50",
                                high = "grey100",
                                na.value = "white") +
  ggplot2::coord_fixed(expand = FALSE) +
  ggplot2::theme_bw() +
  ggplot2::theme(panel.grid.major = ggplot2::element_blank(),
                 panel.grid.minor = ggplot2::element_blank(),
                 legend.position = "none",
                 axis.title.x = ggplot2::element_blank(),
                 axis.title.y = ggplot2::element_blank())
```

```{r}
km1_nonResiduals <- selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-1.x3p",
                                                  ransacIters = 200,
                                                  ransacInlierThresh = 10^-5,
                                                  ransacFinalSelectThresh = 2*(10^-5),
                                                  useResiduals = FALSE)
km2_nonResiduals <- selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-2.x3p",
                                                  ransacIters = 200,
                                                  ransacInlierThresh = 10^-5,
                                                  ransacFinalSelectThresh = 2*(10^-5),
                                                  useResiduals = FALSE)
unknown1_nonResiduals <- selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul F.x3p",
                                                       ransacIters = 200,
                                                       ransacInlierThresh = 10^-5,
                                                       ransacFinalSelectThresh = 2*(10^-5),
                                                       useResiduals = FALSE)
unknown2_nonResiduals <- selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_2/cc/Fadul 2-1.x3p",
                                                       ransacIters = 200,
                                                       ransacInlierThresh = 10^-5,
                                                       ransacFinalSelectThresh = 2*(10^-5),
                                                       useResiduals = FALSE)
```

```{r}
imager::imlist(imager::as.cimg(km1_nonResiduals$x3p$surface.matrix),
               imager::as.cimg(km2_nonResiduals$x3p$surface.matrix),
               imager::as.cimg(unknown1_nonResiduals$x3p$surface.matrix),
               imager::as.cimg(unknown2_nonResiduals$x3p$surface.matrix)) %>%
  plot()
```

```{r}
km1Unknown1CCF_nonResiduals <- cellCCF_bothDirections(x3p1 = km1_nonResiduals$x3p,
                                                      x3p2 = unknown1_nonResiduals$x3p,
                                                      thetas = seq(-30,30,by = 3),
                                                      cellNumHoriz = 8,
                                                      cellNumVert = 8,
                                                      centerCell = "wholeMatrix")

km1Unknown2CCF_nonResiduals <- cellCCF_bothDirections(x3p1 = km1_nonResiduals$x3p,
                                                      x3p2 = unknown2_nonResiduals$x3p,
                                                      thetas = seq(-30,30,by = 3),
                                                      cellNumHoriz = 8,
                                                      cellNumVert = 8,
                                                      centerCell = "wholeMatrix")

km2Unknown1CCF_nonResiduals <- cellCCF_bothDirections(x3p1 = km2_nonResiduals$x3p,
                                                      x3p2 = unknown1_nonResiduals$x3p,
                                                      thetas = seq(-30,30,by = 3),
                                                      cellNumHoriz = 8,
                                                      cellNumVert = 8,
                                                      centerCell = "wholeMatrix")

km2Unknown2CCF_nonResiduals <- cellCCF_bothDirections(x3p1 = km2_nonResiduals$x3p,
                                                      x3p2 = unknown2_nonResiduals$x3p,
                                                      thetas = seq(-30,30,by = 3),
                                                      cellNumHoriz = 8,
                                                      cellNumVert = 8,
                                                      centerCell = "wholeMatrix")
```

```{r}
km1Unknown1CMCs_nonResiduals <- cmcFilter_improved(km1Unknown1CCF_nonResiduals,
                                                   consensus_function = median,
                                                   ccf_thresh = .4,
                                                   dx_thresh = 25,
                                                   theta_thresh = 3,
                                                   consensus_function_theta = median)

km1Unknown2CMCs_nonResiduals <- cmcFilter_improved(km1Unknown2CCF_nonResiduals,
                                                   consensus_function = median,
                                                   ccf_thresh = .4,
                                                   dx_thresh = 25,
                                                   theta_thresh = 3,
                                                   consensus_function_theta = median)

km2Unknown1CMCs_nonResiduals <- cmcFilter_improved(km2Unknown1CCF_nonResiduals,
                                                   consensus_function = median,
                                                   ccf_thresh = .4,
                                                   dx_thresh = 25,
                                                   theta_thresh = 3,
                                                   consensus_function_theta = median)

km2Unknown2CMCs_nonResiduals <- cmcFilter_improved(km2Unknown2CCF_nonResiduals,
                                                   consensus_function = median,
                                                   ccf_thresh = .4,
                                                   dx_thresh = 25,
                                                   theta_thresh = 3,
                                                   consensus_function_theta = median)

km1Unknown1CMCs_nonResiduals$finalCMCs
km1Unknown2CMCs_nonResiduals$finalCMCs
km2Unknown1CMCs_nonResiduals$finalCMCs
km2Unknown2CMCs_nonResiduals$finalCMCs
```

Select breech face impressions selecting the residuals between the RANSAC fitted plane and raw values.

```{r}
km1_Residuals <- selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-1.x3p",
                                               ransacIters = 200,
                                               ransacInlierThresh = 10^-5,
                                               ransacFinalSelectThresh = 2*(10^-5),
                                               useResiduals = TRUE)
km2_Residuals <- selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-2.x3p",
                                               ransacIters = 200,
                                               ransacInlierThresh = 10^-5,
                                               ransacFinalSelectThresh = 2*(10^-5),
                                               useResiduals = TRUE)
unknown1_Residuals <- selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul F.x3p",
                                                    ransacIters = 200,
                                                    ransacInlierThresh = 10^-5,
                                                    ransacFinalSelectThresh = 2*(10^-5),
                                                    useResiduals = TRUE)
unknown2_Residuals <- selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_2/cc/Fadul 2-1.x3p",
                                                    ransacIters = 200,
                                                    ransacInlierThresh = 10^-5,
                                                    ransacFinalSelectThresh = 2*(10^-5),
                                                    useResiduals = TRUE)
```


```{r}
imager::imlist(imager::as.cimg(km1_Residuals$x3p$surface.matrix),
               imager::as.cimg(km2_Residuals$x3p$surface.matrix),
               imager::as.cimg(unknown1_Residuals$x3p$surface.matrix),
               imager::as.cimg(unknown2_Residuals$x3p$surface.matrix)) %>%
  plot()
```

```{r}
km1Unknown1CCF_Residuals <- cellCCF_bothDirections(x3p1 = km1_Residuals$x3p,
                                                   x3p2 = unknown1_Residuals$x3p,
                                                   thetas = seq(-30,30,by = 3),
                                                   cellNumHoriz = 8,
                                                   cellNumVert = 8,
                                                   centerCell = "wholeMatrix")

km1Unknown2CCF_Residuals <- cellCCF_bothDirections(x3p1 = km1_Residuals$x3p,
                                                   x3p2 = unknown2_Residuals$x3p,
                                                   thetas = seq(-30,30,by = 3),
                                                   cellNumHoriz = 8,
                                                   cellNumVert = 8,
                                                   centerCell = "wholeMatrix")

km2Unknown1CCF_Residuals <- cellCCF_bothDirections(x3p1 = km2_Residuals$x3p,
                                                   x3p2 = unknown1_Residuals$x3p,
                                                   thetas = seq(-30,30,by = 3),
                                                   cellNumHoriz = 8,
                                                   cellNumVert = 8,
                                                   centerCell = "wholeMatrix")

km2Unknown2CCF_Residuals <- cellCCF_bothDirections(x3p1 = km2_Residuals$x3p,
                                                   x3p2 = unknown2_Residuals$x3p,
                                                   thetas = seq(-30,30,by = 3),
                                                   cellNumHoriz = 8,
                                                   cellNumVert = 8,
                                                   centerCell = "wholeMatrix")
```

```{r}
km1Unknown1CMCs_Residuals <- cmcFilter_improved(km1Unknown1CCF_Residuals,
                                                consensus_function = median,
                                                ccf_thresh = .4,
                                                dx_thresh = 30,
                                                theta_thresh = 3,
                                                consensus_function_theta = median)

km1Unknown2CMCs_Residuals <- cmcFilter_improved(km1Unknown2CCF_Residuals,
                                                consensus_function = median,
                                                ccf_thresh = .4,
                                                dx_thresh = 30,
                                                theta_thresh = 3,
                                                consensus_function_theta = median)

km2Unknown1CMCs_Residuals <- cmcFilter_improved(km2Unknown1CCF_Residuals,
                                                consensus_function = median,
                                                ccf_thresh = .4,
                                                dx_thresh = 30,
                                                theta_thresh = 3,
                                                consensus_function_theta = median)

km2Unknown2CMCs_Residuals <- cmcFilter_improved(km2Unknown2CCF_Residuals,
                                                consensus_function = median,
                                                ccf_thresh = .4,
                                                dx_thresh = 30,
                                                theta_thresh = 3,
                                                consensus_function_theta = median)

km1Unknown1CMCs_Residuals$finalCMCs
km1Unknown2CMCs_Residuals$finalCMCs
km2Unknown1CMCs_Residuals$finalCMCs
km2Unknown2CMCs_Residuals$finalCMCs
```

Exploration of how the method holds up to comparing two copies of the same cartridge case scan (at least up to what is returned by selectBFImpression)

Just take the residuals (no filtering)

```{r}
dat1 <- cmcR::selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-2.x3p",
                                            ransacIters = 300,
                                            useResiduals = TRUE)

dat2 <- cmcR::selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-2.x3p",
                                            ransacIters = 300,
                                            useResiduals = TRUE)

dat1$x3p$surface.matrix %>%
  imager::as.cimg() %>%
  plot()

dat2$x3p$surface.matrix %>%
  imager::as.cimg() %>%
  plot()

dat3 <- cellCCF_bothDirections(x3p1 = dat1$x3p,
                               x3p2 = dat2$x3p,
                               thetas = seq(-30,30,by = 3),
                               cellNumHoriz = 8,
                               cellNumVert = 8,
                               centerCell = "wholeMatrix")

dat3 %>%
  cmcFilter_improved(dx_thresh = 35)
```

Just take the raw values (no filtering):

```{r}
dat1 <- cmcR::selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-2.x3p",
                                            ransacIters = 300,
                                            useResiduals = FALSE)

dat2 <- cmcR::selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-2.x3p",
                                            ransacIters = 300,
                                            useResiduals = FALSE)

dat1$x3p$surface.matrix %>%
  imager::as.cimg() %>%
  plot()

dat2$x3p$surface.matrix %>%
  imager::as.cimg() %>%
  plot()

dat3 <- cellCCF_bothDirections(x3p1 = dat1$x3p,
                               x3p2 = dat2$x3p,
                               thetas = seq(-30,30,by = 3),
                               cellNumHoriz = 8,
                               cellNumVert = 8,
                               centerCell = "wholeMatrix")

dat3 %>%
  cmcFilter_improved(dx_thresh = 35)
```

Take residuals and perform high-pass filter:

```{r}
dat1 <- cmcR::selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-2.x3p",
                                            ransacIters = 300,
                                            useResiduals = TRUE)

dat1_filtered <- cmcR::gaussianFilterBF(selectBFImpression_output = dat1,wavelength = 200,filtertype = "hp")

dat2 <- cmcR::selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-2.x3p",
                                            ransacIters = 300,
                                            useResiduals = TRUE)

dat2_filtered <- cmcR::gaussianFilterBF(selectBFImpression_output = dat2,wavelength = 200,filtertype = "hp")

dat1_filtered$x3p$surface.matrix %>%
  imager::as.cimg() %>%
  plot()

dat2_filtered$x3p$surface.matrix %>%
  imager::as.cimg() %>%
  plot()

dat3 <- cellCCF_bothDirections(x3p1 = dat1_filtered$x3p,
                               x3p2 = dat2_filtered$x3p,
                               thetas = seq(-30,30,by = 3),
                               cellNumHoriz = 8,
                               cellNumVert = 8)

dat3 %>%
  cmcFilter_improved(dx_thresh = 20)
```

I need to fix comparison/filterViaFFT so that we subtract off the correct values for the image edges - the plots below show that the edge images have incorrectly calculated dx/dy values that appear to be far from zero, but that is likely because the number that is being subtracted off to calculate the dx/dy values doesn't take into account the additional padding.

```{r}
cmcR:::getHighCCFPairs(dat1_filtered$x3p,
                       dat1_filtered$x3p,
                       cellCCF_output = dat3$comparison_1to2) %>%
  .$highCCFPairs %>%
  purrr::map(~ cmcR::ccfMapPlot(.[[1]],.[[2]]))

dat3$comparison_1to2$ccfResults %>% topResultsPerCell()

```
