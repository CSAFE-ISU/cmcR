---
output:
  pdf_document: default
  html_document: default
---
---
title: "Cartridge Case Reproducible Example"
output: rmarkdown::html_vignette
vignette: >
%\VignetteIndexEntry{Cartridge Case Reproducible Example}
%\VignetteEngine{knitr::rmarkdown}
%\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(cmcR)
library(magrittr)
```

```{r eval=FALSE}
km1_raw <- x3ptools::read_x3p("../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-1.x3p")
km2_raw <- x3ptools::read_x3p("../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-2.x3p")
unknown1_raw <- x3ptools::read_x3p("../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul F.x3p")
unknown2_raw <- x3ptools::read_x3p("../../bulletCartridgeScans/fadul_allScans/Fadul_2/cc/Fadul 2-1.x3p")


mat1 <- cmcR::selectBFImpression("../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-1.x3p",useResiduals = FALSE)
mat2 <- cmcR::selectBFImpression("../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-2.x3p",useResiduals = FALSE)

mat1$x3p$surface.matrix %>%
  t() %>%
  imager::as.cimg() %>%
  as.data.frame() %>%
  ggplot2::ggplot(ggplot2::aes(x = x,y = y)) +
  ggplot2::geom_raster(ggplot2::aes(fill = value)) +
  ggplot2::scale_fill_gradient2(low = "grey0",
                                mid = "grey50",
                                high = "grey100",
                                na.value = "white",
                                midpoint = median(as.vector(median(as.vector(mat1$x3p$surface.matrix),
                                                                   na.rm = TRUE)))) +
  ggplot2::coord_fixed(expand = FALSE) +
  ggplot2::theme_bw() +
  ggplot2::theme(panel.grid.major = ggplot2::element_blank(),
                 panel.grid.minor = ggplot2::element_blank(),
                 legend.position = "none",
                 axis.title.x = ggplot2::element_blank(),
                 axis.title.y = ggplot2::element_blank())

mat2$x3p$surface.matrix %>%
  t() %>%
  imager::as.cimg() %>%
  as.data.frame() %>%
  ggplot2::ggplot(ggplot2::aes(x = x,y = y)) +
  ggplot2::geom_raster(ggplot2::aes(fill = value)) +
  ggplot2::scale_fill_gradient2(low = "grey0",
                                mid = "grey50",
                                high = "grey100",
                                na.value = "white",
                                midpoint = median(as.vector(median(as.vector(mat2$x3p$surface.matrix),
                                                                   na.rm = TRUE)))) +
  ggplot2::coord_fixed(expand = FALSE) +
  ggplot2::theme_bw() +
  ggplot2::theme(panel.grid.major = ggplot2::element_blank(),
                 panel.grid.minor = ggplot2::element_blank(),
                 legend.position = "none",
                 axis.title.x = ggplot2::element_blank(),
                 axis.title.y = ggplot2::element_blank())

km1_raw$surface.matrix %>%
  t() %>%
  imager::as.cimg() %>%
  as.data.frame() %>%
  ggplot2::ggplot(ggplot2::aes(x = x,y = y)) +
  ggplot2::geom_raster(ggplot2::aes(fill = value)) +
  ggplot2::scale_fill_gradient2(low = "grey0",
                                mid = "grey50",
                                high = "grey100",
                                na.value = "white",
                                midpoint = median(as.vector(median(km1_raw$surface.matrix,
                                                                   na.rm = TRUE)))) +
  ggplot2::coord_fixed(expand = FALSE) +
  ggplot2::theme_bw() +
  ggplot2::theme(panel.grid.major = ggplot2::element_blank(),
                 panel.grid.minor = ggplot2::element_blank(),
                 legend.position = "none",
                 axis.title.x = ggplot2::element_blank(),
                 axis.title.y = ggplot2::element_blank())

km2_raw$surface.matrix %>%
  t() %>%
  imager::as.cimg() %>%
  as.data.frame() %>%
  ggplot2::ggplot(ggplot2::aes(x = x,y = y)) +
  ggplot2::geom_raster(ggplot2::aes(fill = value)) +
  ggplot2::scale_fill_gradient2(low = "grey0",
                                mid = "grey50",
                                high = "grey100",
                                na.value = "white",
                                midpoint = median(as.vector(median(km2_raw$surface.matrix,
                                                                   na.rm = TRUE)))) +
  ggplot2::coord_fixed(expand = FALSE) +
  ggplot2::theme_bw() +
  ggplot2::theme(panel.grid.major = ggplot2::element_blank(),
                 panel.grid.minor = ggplot2::element_blank(),
                 legend.position = "none",
                 axis.title.x = ggplot2::element_blank(),
                 axis.title.y = ggplot2::element_blank())

unknown1_raw$surface.matrix %>%
  t() %>%
  imager::as.cimg() %>%
  as.data.frame() %>%
  ggplot2::ggplot(ggplot2::aes(x = x,y = y)) +
  ggplot2::geom_raster(ggplot2::aes(fill = value)) +
  ggplot2::scale_fill_gradient2(low = "grey0",
                                mid = "grey50",
                                high = "grey100",
                                na.value = "white",
                                midpoint = median(as.vector(median(unknown1_raw$surface.matrix,
                                                                   na.rm = TRUE)))) +
  ggplot2::coord_fixed(expand = FALSE) +
  ggplot2::theme_bw() +
  ggplot2::theme(panel.grid.major = ggplot2::element_blank(),
                 panel.grid.minor = ggplot2::element_blank(),
                 legend.position = "none",
                 axis.title.x = ggplot2::element_blank(),
                 axis.title.y = ggplot2::element_blank())

unknown2_raw$surface.matrix %>%
  t() %>%
  imager::as.cimg() %>%
  as.data.frame() %>%
  ggplot2::ggplot(ggplot2::aes(x = x,y = y)) +
  ggplot2::geom_raster(ggplot2::aes(fill = value)) +
  ggplot2::scale_fill_gradient2(low = "grey0",
                                mid = "grey50",
                                high = "grey100",
                                na.value = "white",
                                midpoint = median(as.vector(median(unknown2_raw$surface.matrix,
                                                                   na.rm = TRUE)))) +
  ggplot2::coord_fixed(expand = FALSE) +
  ggplot2::theme_bw() +
  ggplot2::theme(panel.grid.major = ggplot2::element_blank(),
                 panel.grid.minor = ggplot2::element_blank(),
                 legend.position = "none",
                 axis.title.x = ggplot2::element_blank(),
                 axis.title.y = ggplot2::element_blank())
```


Select breech face impressions selecting the residuals between the RANSAC fitted plane and raw values.

```{r }
set.seed(3152020)

km1_Residuals <- selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-1.x3p",
                                               ransacIters = 150,
                                               ransacInlierThresh = 10^-5,
                                               ransacFinalSelectThresh = 2*(10^-5),
                                               useResiduals = TRUE)
km2_Residuals <- selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul 1-2.x3p",
                                               ransacIters = 150,
                                               ransacInlierThresh = 10^-5,
                                               ransacFinalSelectThresh = 2*(10^-5),
                                               useResiduals = TRUE)
unknown1_Residuals <- selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_1/cc/Fadul F.x3p",
                                                    ransacIters = 150,
                                                    ransacInlierThresh = 10^-5,
                                                    ransacFinalSelectThresh = 2*(10^-5),
                                                    useResiduals = TRUE)
unknown2_Residuals <- selectBFImpression_sample_x3p(x3p_path = "../../bulletCartridgeScans/fadul_allScans/Fadul_2/cc/Fadul 2-1.x3p",
                                                    ransacIters = 150,
                                                    ransacInlierThresh = 10^-5,
                                                    ransacFinalSelectThresh = 2*(10^-5),
                                                    useResiduals = TRUE)
```

```{r eval=FALSE}
km1_Residuals$x3p$surface.matrix %>% 
  t() %>%
  imager::as.cimg() %>%
  as.data.frame() %>%
  ggplot2::ggplot(ggplot2::aes(x = x,y = y)) +
  ggplot2::geom_raster(ggplot2::aes(fill = value)) +
  ggplot2::scale_fill_gradient2(low = "grey0",
                                mid = "grey50",
                                high = "grey100",
                                na.value = "white") +
  ggplot2::coord_fixed(expand = FALSE) +
  ggplot2::theme_bw() +
  ggplot2::theme(panel.grid.major = ggplot2::element_blank(),
                 panel.grid.minor = ggplot2::element_blank(),
                 legend.position = "none",
                 axis.title.x = ggplot2::element_blank(),
                 axis.title.y = ggplot2::element_blank())

km2_Residuals$x3p$surface.matrix %>% 
  t() %>%
  imager::as.cimg() %>%
  as.data.frame() %>%
  ggplot2::ggplot(ggplot2::aes(x = x,y = y)) +
  ggplot2::geom_raster(ggplot2::aes(fill = value)) +
  ggplot2::scale_fill_gradient2(low = "grey0",
                                mid = "grey50",
                                high = "grey100",
                                na.value = "white") +
  ggplot2::coord_fixed(expand = FALSE) +
  ggplot2::theme_bw() +
  ggplot2::theme(panel.grid.major = ggplot2::element_blank(),
                 panel.grid.minor = ggplot2::element_blank(),
                 legend.position = "none",
                 axis.title.x = ggplot2::element_blank(),
                 axis.title.y = ggplot2::element_blank())

unknown1_Residuals$x3p$surface.matrix %>% 
  t() %>%
  imager::as.cimg() %>%
  as.data.frame() %>%
  ggplot2::ggplot(ggplot2::aes(x = x,y = y)) +
  ggplot2::geom_raster(ggplot2::aes(fill = value)) +
  ggplot2::scale_fill_gradient2(low = "grey0",
                                mid = "grey50",
                                high = "grey100",
                                na.value = "white") +
  ggplot2::coord_fixed(expand = FALSE) +
  ggplot2::theme_bw() +
  ggplot2::theme(panel.grid.major = ggplot2::element_blank(),
                 panel.grid.minor = ggplot2::element_blank(),
                 legend.position = "none",
                 axis.title.x = ggplot2::element_blank(),
                 axis.title.y = ggplot2::element_blank())

unknown2_Residuals$x3p$surface.matrix %>% 
  t() %>%
  imager::as.cimg() %>%
  as.data.frame() %>%
  ggplot2::ggplot(ggplot2::aes(x = x,y = y)) +
  ggplot2::geom_raster(ggplot2::aes(fill = value)) +
  ggplot2::scale_fill_gradient2(low = "grey0",
                                mid = "grey50",
                                high = "grey100",
                                na.value = "white") +
  ggplot2::coord_fixed(expand = FALSE) +
  ggplot2::theme_bw() +
  ggplot2::theme(panel.grid.major = ggplot2::element_blank(),
                 panel.grid.minor = ggplot2::element_blank(),
                 legend.position = "none",
                 axis.title.x = ggplot2::element_blank(),
                 axis.title.y = ggplot2::element_blank())
```

```{r}
km1_Residuals$x3p$surface.matrix <- 
  cmcR::preProcess_gaussFilter(surfaceMat = km1_Residuals$x3p$surface.matrix,
                               res = km1_Residuals$x3p$header.info$incrementY,
                               wavelength = 16,
                               filtertype = "lp")

km2_Residuals$x3p$surface.matrix <- 
  cmcR::preProcess_gaussFilter(surfaceMat = km2_Residuals$x3p$surface.matrix,
                               res = km2_Residuals$x3p$header.info$incrementY,
                               wavelength = 16,
                               filtertype = "lp")

unknown1_Residuals$x3p$surface.matrix <- 
  cmcR::preProcess_gaussFilter(surfaceMat = unknown1_Residuals$x3p$surface.matrix,
                               res = unknown1_Residuals$x3p$header.info$incrementY,
                               wavelength = 16,
                               filtertype = "lp")

unknown2_Residuals$x3p$surface.matrix <- 
  cmcR::preProcess_gaussFilter(surfaceMat = unknown2_Residuals$x3p$surface.matrix,
                               res = unknown2_Residuals$x3p$header.info$incrementY,
                               wavelength = 16,
                               filtertype = "lp")
```

```{r}
km1_Residuals$x3p$surface.matrix %>% 
  t() %>%
  imager::as.cimg() %>%
  as.data.frame() %>%
  ggplot2::ggplot(ggplot2::aes(x = x,y = y)) +
  ggplot2::geom_raster(ggplot2::aes(fill = value)) +
  ggplot2::scale_fill_gradient2(low = "grey0",
                                mid = "grey50",
                                high = "grey100",
                                na.value = "white") +
  ggplot2::coord_fixed(expand = FALSE) +
  ggplot2::theme_bw() +
  ggplot2::theme(panel.grid.major = ggplot2::element_blank(),
                 panel.grid.minor = ggplot2::element_blank(),
                 legend.position = "none",
                 axis.title.x = ggplot2::element_blank(),
                 axis.title.y = ggplot2::element_blank())

km2_Residuals$x3p$surface.matrix %>% 
  t() %>%
  imager::as.cimg() %>%
  as.data.frame() %>%
  ggplot2::ggplot(ggplot2::aes(x = x,y = y)) +
  ggplot2::geom_raster(ggplot2::aes(fill = value)) +
  ggplot2::scale_fill_gradient2(low = "grey0",
                                mid = "grey50",
                                high = "grey100",
                                na.value = "white") +
  ggplot2::coord_fixed(expand = FALSE) +
  ggplot2::theme_bw() +
  ggplot2::theme(panel.grid.major = ggplot2::element_blank(),
                 panel.grid.minor = ggplot2::element_blank(),
                 legend.position = "none",
                 axis.title.x = ggplot2::element_blank(),
                 axis.title.y = ggplot2::element_blank())

unknown1_Residuals$x3p$surface.matrix %>% 
  t() %>%
  imager::as.cimg() %>%
  as.data.frame() %>%
  ggplot2::ggplot(ggplot2::aes(x = x,y = y)) +
  ggplot2::geom_raster(ggplot2::aes(fill = value)) +
  ggplot2::scale_fill_gradient2(low = "grey0",
                                mid = "grey50",
                                high = "grey100",
                                na.value = "white") +
  ggplot2::coord_fixed(expand = FALSE) +
  ggplot2::theme_bw() +
  ggplot2::theme(panel.grid.major = ggplot2::element_blank(),
                 panel.grid.minor = ggplot2::element_blank(),
                 legend.position = "none",
                 axis.title.x = ggplot2::element_blank(),
                 axis.title.y = ggplot2::element_blank())

unknown2_Residuals$x3p$surface.matrix %>% 
  t() %>%
  imager::as.cimg() %>%
  as.data.frame() %>%
  ggplot2::ggplot(ggplot2::aes(x = x,y = y)) +
  ggplot2::geom_raster(ggplot2::aes(fill = value)) +
  ggplot2::scale_fill_gradient2(low = "grey0",
                                mid = "grey50",
                                high = "grey100",
                                na.value = "white") +
  ggplot2::coord_fixed(expand = FALSE) +
  ggplot2::theme_bw() +
  ggplot2::theme(panel.grid.major = ggplot2::element_blank(),
                 panel.grid.minor = ggplot2::element_blank(),
                 legend.position = "none",
                 axis.title.x = ggplot2::element_blank(),
                 axis.title.y = ggplot2::element_blank())
```


```{r}
km1_unknown1_comparison <- cellCCF_bothDirections(km1_Residuals$x3p,
                                                  unknown1_Residuals$x3p,
                                                  thetas = seq(-30,30,by = 3),
                                                  cellNumHoriz = 8,
                                                  cellNumVert = 8,
                                                  regionToCellProp = 4,
                                                  minObservedProp = .15,
                                                  centerCell = "individualCell",
                                                  scaleCell = "individualCell")

dplyr::bind_rows(
  km1_unknown1_comparison$comparison_1to2$ccfResults %>%
    cmcR:::cmcFilterPerTheta(consensus_function = median,
                             corr_thresh = .4,
                             dx_thresh = 15,
                             dy_thresh = 15,
                             theta_thresh = 3) %>%
    dplyr::mutate(comparison = "A vs. B"),
  km1_unknown1_comparison$comparison_2to1$ccfResults %>%
    cmcR:::cmcFilterPerTheta(consensus_function = median,
                             corr_thresh = .4,
                             dx_thresh = 15,
                             dy_thresh = 15,
                             theta_thresh = 3) %>%
    dplyr::mutate(comparison = "B vs. A")
) %>%
  dplyr::group_by(comparison,theta) %>%
  dplyr::tally() %>%
  dplyr::mutate(cmcHigh = max(n) - 1)  %>%
  ggplot2::ggplot(ggplot2::aes(x = theta,y = n)) +
  ggplot2::geom_bar(stat = "identity") +
  ggplot2::theme_bw()  +
  ggplot2::xlab(expression(theta*" (degree)")) +
  ggplot2::ylab("CMC number") +
  ggplot2::facet_wrap(~ comparison,ncol = 1)  +
  ggplot2::ylim(c(NA,20)) +
  ggplot2::geom_hline(ggplot2::aes(yintercept = cmcHigh),
                      colour = "black",
                      linetype = "dashed") +
  ggplot2::geom_text(ggplot2::aes(x = min(theta) + 3,
                                  y = cmcHigh,
                                  label = paste0("High CMC = ",cmcHigh)),
                     nudge_y = 1,
                     fontface = "plain",
                     family = "sans")
```

```{r}
km1_unknown2_comparison <- cellCCF_bothDirections(km1_Residuals$x3p,
                                                  unknown2_Residuals$x3p,
                                                  thetas = seq(-30,30,by = 3),
                                                  cellNumHoriz = 8,
                                                  cellNumVert = 8,
                                                  regionToCellProp = 4,
                                                  minObservedProp = .15,
                                                  centerCell = "individualCell",
                                                  scaleCell = "individualCell")

dplyr::bind_rows(
  km1_unknown2_comparison$comparison_1to2$ccfResults %>%
    cmcR:::cmcFilterPerTheta(consensus_function = median,
                             corr_thresh = .4,
                             dx_thresh = 15,
                             dy_thresh = 15,
                             theta_thresh = 3) %>%
    dplyr::mutate(comparison = "A vs. B"),
  km1_unknown2_comparison$comparison_2to1$ccfResults %>%
    cmcR:::cmcFilterPerTheta(consensus_function = median,
                             corr_thresh = .4,
                             dx_thresh = 15,
                             dy_thresh = 15,
                             theta_thresh = 3) %>%
    dplyr::mutate(comparison = "B vs. A")
) %>%
  dplyr::group_by(comparison,theta) %>%
  dplyr::tally() %>%
  dplyr::mutate(cmcHigh = max(n) - 1) %>%
  ggplot2::ggplot(ggplot2::aes(x = theta,y = n)) +
  ggplot2::geom_bar(stat = "identity") +
  ggplot2::theme_bw() +
  ggplot2::xlab(expression(theta*" (degree)")) +
  ggplot2::ylab("CMC number") +
  ggplot2::facet_wrap(~ comparison,ncol = 1) +
  ggplot2::ylim(c(NA,20))  +
  ggplot2::geom_hline(ggplot2::aes(yintercept = cmcHigh),
                      colour = "black",
                      linetype = "dashed") +
  ggplot2::geom_text(ggplot2::aes(x = min(theta) + 3,
                                  y = cmcHigh,
                                  label = paste0("High CMC = ",cmcHigh)),
                     nudge_y = 1,
                     fontface = "plain",
                     family = "sans")
```

```{r}
km1_unknown1_cmcs <- cmcR::cmcFilter_improved(km1_unknown1_comparison,
                                              consensus_function = median,
                                              corr_thresh = .55,
                                              dx_thresh = 15)

km1_unknown2_cmcs <- cmcR::cmcFilter_improved(km1_unknown2_comparison,
                                              consensus_function = median,
                                              corr_thresh = .55,
                                              dx_thresh = 15)
```

```{r}
km1_unknown1_cmcs$finalCMCs
```


```{r}
km2_unknown1_comparison <- cellCCF_bothDirections(km2_Residuals$x3p,
                                                  unknown1_Residuals$x3p,
                                                  thetas = seq(-30,30,by = 3),
                                                  cellNumHoriz = 8,
                                                  regionToCellProp = 4,
                                                  minObservedProp = .15,
                                                  centerCell = "individualCell",
                                                  scaleCell = "individualCell")

km2_unknown2_comparison <- cellCCF_bothDirections(km2_Residuals$x3p,
                                                  unknown2_Residuals$x3p,
                                                  thetas = seq(-30,30,by = 3),
                                                  cellNumHoriz = 8,
                                                  regionToCellProp = 4,
                                                  minObservedProp = .15,
                                                  centerCell = "individualCell",
                                                  scaleCell = "individualCell")

km2_unknown1_cmcs <- cmcR::cmcFilter_improved(km2_unknown1_comparison,
                                              consensus_function = median,
                                              corr_thresh = .55,
                                              dx_thresh = 15)

km2_unknown2_cmcs <- cmcR::cmcFilter_improved(km2_unknown2_comparison,
                                              consensus_function = median,
                                              corr_thresh = .55,
                                              dx_thresh = 15)
```

```{r}
km2_unknown2_cmcs$finalCMCs
```


```{r eval=FALSE}
cmcR::cmcPlot(unknown1_Residuals$x3p,
              cmcDF = km1_unknown1_cmcs$initialCMCs[[1]][[2]],
              method = "ggplot2")
```



```{r eval=FALSE}
cmcR::cmcPlot(unknown2_Residuals$x3p,
              cmcDF = km1_unknown2_cmcs$initialCMCs[[1]][[2]],
              method = "ggplot2")
```

```{r}
cmcR::cmcPlot(unknown1_Residuals$x3p,
              cmcDF = km2_unknown1_cmcs$initialCMCs[[1]][[1]],
              method = "ggplot2")
```

```{r}
cmcR::cmcPlot(unknown2_Residuals$x3p,
              cmcDF = km2_unknown2_cmcs$initialCMCs[[1]][[2]],
              method = "ggplot2")
```

```{r}
cmcR::cmcPlot(unknown1_Residuals$x3p,
              cmcDF = km2_unknown1_cmcs$finalCMCs,
              method = "ggplot2")
```

TODO:
  Get calcRawCorr working (I think this is done)
  Function tests
  Better documentation
  Add an official "cmc" function that just calls cellCCF_bothDirections and cmcFilter_improved
  
  Continue running things on the server to get more final results
  Conclusion/Future Work chapter?
  Hough transform circle accumulator image still needed