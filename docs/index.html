<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>An Implementation of the Congruent Matching Cells Method • cmcR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="An Implementation of the Congruent Matching Cells Method">
<meta property="og:description" content="An open-source implementation of the Congruent Matching Cells 
    method for cartridge case identification as proposed by Song (2013) &lt;https://tsapps.nist.gov/publication/get_pdf.cfm?pub_id=911193&gt; as well 
    as an extension of the method proposed by Tong et al. (2015) &lt;doi:10.6028&gt; (10.6028/jres.120.008).
    Provides a wide range of pre, inter, and post-processing options when
    working with cartridge case scan data and their associated comparisons. See
    the cmcR package website for more details and examples.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">cmcR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.9</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/cmcR_plotReproduction.html">Reproduction of Song et al. (2018) plots using the cmcR package</a>
    </li>
    <li>
      <a href="articles/decisionRuleDescription.html">CMC Decision Rule Description</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div class="section level1">
<div class="page-header"><h1 id="cmcr">cmcR<a class="anchor" aria-label="anchor" href="#cmcr"></a>
</h1></div>
<!-- badges: start -->

<p>The cmcR package provides an open-source implementation of the Congruent Matching Cells method for cartridge case identification as proposed by <a href="https://tsapps.nist.gov/publication/get_pdf.cfm?pub_id=911193" class="external-link">Song (2013)</a> as well as the “High CMC” method proposed by <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4730689/pdf/jres.120.008.pdf" class="external-link">Tong et al. (2015)</a>.</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<!-- You can install the released version of cmcR from [CRAN](https://CRAN.R-project.org) with: -->
<!-- ``` r -->
<!-- install.packages("cmcR") -->
<!-- ``` -->
<p>Install the development version from <a href="https://github.com/CSAFE-ISU/cmcR" class="external-link">GitHub</a> with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("devtools")</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org/reference/remote-reexports.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"jzemmels/cmcR@dev"</span><span class="op">)</span></code></pre></div>
<p>Cartridge case scan data can be accessed at the <a href="https://tsapps.nist.gov/NRBTD/Studies/Search" class="external-link">NIST Ballisitics Toolmark Research Database</a></p>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>We will illustrate the package’s functionality here. Please refer to the package vignettes available under the “Articles” tab of the <a href="https://csafe-isu.github.io/cmcR/index.html" class="external-link">package website</a> for more information.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">cmcR</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/heike/x3ptools" class="external-link">x3ptools</a></span><span class="op">)</span></code></pre></div>
<p>Consider the known match cartridge case pair Fadul 1-1 and Fadul 1-2. The <code>read_x3p</code> function from the <a href="https://github.com/heike/x3ptools" class="external-link">x3ptools</a> package can read scans from the <a href="https://tsapps.nist.gov/NRBTD/Studies/Search" class="external-link">NBTRD</a> given the appropriate address. The two scans are read below and visualized using the <a href="https://csafe-isu.github.io/cmcR/reference/x3pListPlot.html" class="external-link"><code>x3pListPlot</code></a> function.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fadul1.1_id</span> <span class="op">&lt;-</span> <span class="st">"DownloadMeasurement/2d9cc51f-6f66-40a0-973a-a9292dbee36d"</span>
<span class="co"># Same source comparison</span>
<span class="va">fadul1.2_id</span> <span class="op">&lt;-</span> <span class="st">"DownloadMeasurement/cb296c98-39f5-46eb-abff-320a2f5568e8"</span>

<span class="co"># Code to download breech face impressions:</span>
<span class="va">nbtrd_url</span> <span class="op">&lt;-</span> <span class="st">"https://tsapps.nist.gov/NRBTD/Studies/CartridgeMeasurement/"</span>

<span class="va">fadul1.1_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/x3ptools/man/x3p_read.html" class="external-link">x3p_read</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">nbtrd_url</span>,<span class="va">fadul1.1_id</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu">x3ptools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/x3ptools/man/x3p_scale_unit.html" class="external-link">x3p_scale_unit</a></span><span class="op">(</span>scale_by <span class="op">=</span> <span class="fl">1e6</span><span class="op">)</span>
<span class="va">fadul1.2_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/x3ptools/man/x3p_read.html" class="external-link">x3p_read</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">nbtrd_url</span>,<span class="va">fadul1.2_id</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu">x3ptools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/x3ptools/man/x3p_scale_unit.html" class="external-link">x3p_scale_unit</a></span><span class="op">(</span>scale_by <span class="op">=</span> <span class="fl">1e6</span><span class="op">)</span>

<span class="fu"><a href="reference/x3pListPlot.html">x3pListPlot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Fadul 1-1"</span> <span class="op">=</span> <span class="va">fadul1.1_raw</span>,
                 <span class="st">"Fadul 1-2"</span> <span class="op">=</span> <span class="va">fadul1.2_raw</span><span class="op">)</span>,
            type <span class="op">=</span> <span class="st">"faceted"</span><span class="op">)</span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-2-1.png" width="100%"></p>
<div class="section level3">
<h3 id="preprocessing">Preprocessing<a class="anchor" aria-label="anchor" href="#preprocessing"></a>
</h3>
<p>To perform a proper comparison of these two cartridge cases, we need to remove regions that do not come into uniform or consistent contact with the breech face of the firearm. These include the small clusters of pixels in the corners of the two scans from the microscope staging area, and the plateaued region of points around the firing pin impression hole near the center of the scan. A variety of processing procedures are implemented in the cmcR package. Functions of the form <code>preProcess_*</code> perform the preprocessing procedures. See the <a href="https://csafe-isu.github.io/cmcR/reference/index.html" class="external-link">funtion reference</a> of the cmcR package for more information regarding these procedures. As is commonly done when comparing cartridge cases, we downsample each scan (by a factor of 4, selecting every other row/column) using the <code>sample_x3p</code> function.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fadul1.1_processed</span> <span class="op">&lt;-</span> <span class="va">fadul1.1_raw</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu">x3ptools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/x3ptools/man/x3p_sample.html" class="external-link">sample_x3p</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="reference/preProcess_crop.html">preProcess_crop</a></span><span class="op">(</span>region <span class="op">=</span> <span class="st">"exterior"</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="reference/preProcess_crop.html">preProcess_crop</a></span><span class="op">(</span>region <span class="op">=</span> <span class="st">"interior"</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="reference/preProcess_erode.html">preProcess_erode</a></span><span class="op">(</span>region <span class="op">=</span> <span class="st">"exterior"</span>,morphRadius <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="reference/preProcess_erode.html">preProcess_erode</a></span><span class="op">(</span>region <span class="op">=</span> <span class="st">"interior"</span>,morphRadius <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="reference/preProcess_removeTrend.html">preProcess_removeTrend</a></span><span class="op">(</span>statistic <span class="op">=</span> <span class="st">"quantile"</span>,
                         tau <span class="op">=</span> <span class="fl">.5</span>,
                         method <span class="op">=</span> <span class="st">"fn"</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="reference/preProcess_gaussFilter.html">preProcess_gaussFilter</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">fadul1.2_processed</span> <span class="op">&lt;-</span> <span class="va">fadul1.2_raw</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu">x3ptools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/x3ptools/man/x3p_sample.html" class="external-link">sample_x3p</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="reference/preProcess_crop.html">preProcess_crop</a></span><span class="op">(</span>region <span class="op">=</span> <span class="st">"exterior"</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="reference/preProcess_crop.html">preProcess_crop</a></span><span class="op">(</span>region <span class="op">=</span> <span class="st">"interior"</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="reference/preProcess_erode.html">preProcess_erode</a></span><span class="op">(</span>region <span class="op">=</span> <span class="st">"exterior"</span>,morphRadius <span class="op">=</span> <span class="fl">15</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="reference/preProcess_erode.html">preProcess_erode</a></span><span class="op">(</span>region <span class="op">=</span> <span class="st">"interior"</span>,morphRadius <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="reference/preProcess_removeTrend.html">preProcess_removeTrend</a></span><span class="op">(</span>statistic <span class="op">=</span> <span class="st">"quantile"</span>,
                         tau <span class="op">=</span> <span class="fl">.5</span>,
                         method <span class="op">=</span> <span class="st">"fn"</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="reference/preProcess_gaussFilter.html">preProcess_gaussFilter</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="reference/x3pListPlot.html">x3pListPlot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Processed Fadul 1-1"</span> <span class="op">=</span> <span class="va">fadul1.1_processed</span>,
                 <span class="st">"Processed Fadul1-2"</span> <span class="op">=</span> <span class="va">fadul1.2_processed</span><span class="op">)</span>,
            type <span class="op">=</span> <span class="st">"faceted"</span><span class="op">)</span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-3-1.png" width="100%"></p>
</div>
<div class="section level3">
<h3 id="cell-based-comparison-procedure">Cell-based comparison procedure<a class="anchor" aria-label="anchor" href="#cell-based-comparison-procedure"></a>
</h3>
<p>Functions of the form <code>comparison_*</code> perform the steps of the cell-based comparison procedure. The data generated from the cell-based comparison procedure are kept in a <a href="https://tibble.tidyverse.org/" class="external-link"><code>tibble</code></a> where one row represents a single cell/region pairing.</p>
<p>The <code>comparison_cellDivision</code> function divides a scan up into a grid of cells. The <code>cellIndex</code> column represents the <code>row,col</code> location in the original scan each cell inhabits. Each cell is stored as an <code>.x3p</code> object in the <code>cellHeightValues</code> column. The benefit of using a <code>tibble</code> structure is that processes such as removing rows can be accomplished using simple <code>dplyr</code> commands such as <code>filter</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cellTibble</span> <span class="op">&lt;-</span> <span class="va">fadul1.1_processed</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="reference/comparison_cellDivision.html">comparison_cellDivision</a></span><span class="op">(</span>numCells <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8</span>,<span class="fl">8</span><span class="op">)</span><span class="op">)</span>

<span class="va">cellTibble</span>
<span class="co">#&gt; # A tibble: 64 x 2</span>
<span class="co">#&gt;    cellIndex cellHeightValues</span>
<span class="co">#&gt;    &lt;chr&gt;     &lt;named list&gt;    </span>
<span class="co">#&gt;  1 1, 1      &lt;x3p&gt;           </span>
<span class="co">#&gt;  2 1, 2      &lt;x3p&gt;           </span>
<span class="co">#&gt;  3 1, 3      &lt;x3p&gt;           </span>
<span class="co">#&gt;  4 1, 4      &lt;x3p&gt;           </span>
<span class="co">#&gt;  5 1, 5      &lt;x3p&gt;           </span>
<span class="co">#&gt;  6 1, 6      &lt;x3p&gt;           </span>
<span class="co">#&gt;  7 1, 7      &lt;x3p&gt;           </span>
<span class="co">#&gt;  8 1, 8      &lt;x3p&gt;           </span>
<span class="co">#&gt;  9 2, 1      &lt;x3p&gt;           </span>
<span class="co">#&gt; 10 2, 2      &lt;x3p&gt;           </span>
<span class="co">#&gt; # ... with 54 more rows</span></code></pre></div>
<p>The <code>comparison_getTargetRegions</code> function extracts a region from a target scan (in this case Fadul 1-2) to be paired with each cell in the reference scan.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cellTibble</span> <span class="op">&lt;-</span> <span class="va">cellTibble</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>regionHeightValues <span class="op">=</span> <span class="fu"><a href="reference/comparison_getTargetRegions.html">comparison_getTargetRegions</a></span><span class="op">(</span>cellHeightValues <span class="op">=</span> <span class="va">cellHeightValues</span>,
                                                          target <span class="op">=</span> <span class="va">fadul1.2_processed</span><span class="op">)</span><span class="op">)</span>

<span class="va">cellTibble</span>
<span class="co">#&gt; # A tibble: 64 x 3</span>
<span class="co">#&gt;    cellIndex cellHeightValues regionHeightValues</span>
<span class="co">#&gt;    &lt;chr&gt;     &lt;named list&gt;     &lt;named list&gt;      </span>
<span class="co">#&gt;  1 1, 1      &lt;x3p&gt;            &lt;x3p&gt;             </span>
<span class="co">#&gt;  2 1, 2      &lt;x3p&gt;            &lt;x3p&gt;             </span>
<span class="co">#&gt;  3 1, 3      &lt;x3p&gt;            &lt;x3p&gt;             </span>
<span class="co">#&gt;  4 1, 4      &lt;x3p&gt;            &lt;x3p&gt;             </span>
<span class="co">#&gt;  5 1, 5      &lt;x3p&gt;            &lt;x3p&gt;             </span>
<span class="co">#&gt;  6 1, 6      &lt;x3p&gt;            &lt;x3p&gt;             </span>
<span class="co">#&gt;  7 1, 7      &lt;x3p&gt;            &lt;x3p&gt;             </span>
<span class="co">#&gt;  8 1, 8      &lt;x3p&gt;            &lt;x3p&gt;             </span>
<span class="co">#&gt;  9 2, 1      &lt;x3p&gt;            &lt;x3p&gt;             </span>
<span class="co">#&gt; 10 2, 2      &lt;x3p&gt;            &lt;x3p&gt;             </span>
<span class="co">#&gt; # ... with 54 more rows</span></code></pre></div>
<p>We want to exclude cells and regions that are mostly missing from the scan. The <code>comparison_calcPropMissing</code> function calculates the proportion of missing values in a surface matrix. The call below excludes rows in which either the cell or region contain more that 85% missing values.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cellTibble</span> <span class="op">&lt;-</span> <span class="va">cellTibble</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cellPropMissing <span class="op">=</span> <span class="fu"><a href="reference/comparison_calcPropMissing.html">comparison_calcPropMissing</a></span><span class="op">(</span><span class="va">cellHeightValues</span><span class="op">)</span>,
         regionPropMissing <span class="op">=</span> <span class="fu"><a href="reference/comparison_calcPropMissing.html">comparison_calcPropMissing</a></span><span class="op">(</span><span class="va">regionHeightValues</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cellPropMissing</span> <span class="op">&lt;=</span> <span class="fl">.85</span> <span class="op">&amp;</span> <span class="va">regionPropMissing</span> <span class="op">&lt;=</span> <span class="fl">.85</span><span class="op">)</span>

<span class="va">cellTibble</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">cellIndex</span>,<span class="va">cellPropMissing</span>,<span class="va">regionPropMissing</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 26 x 3</span>
<span class="co">#&gt;    cellIndex cellPropMissing regionPropMissing</span>
<span class="co">#&gt;    &lt;chr&gt;               &lt;dbl&gt;             &lt;dbl&gt;</span>
<span class="co">#&gt;  1 1, 6                0.786             0.820</span>
<span class="co">#&gt;  2 2, 7                0.533             0.725</span>
<span class="co">#&gt;  3 3, 7                0.831             0.638</span>
<span class="co">#&gt;  4 3, 8                0.536             0.657</span>
<span class="co">#&gt;  5 4, 1                0.308             0.847</span>
<span class="co">#&gt;  6 4, 7                0.840             0.578</span>
<span class="co">#&gt;  7 4, 8                0.268             0.578</span>
<span class="co">#&gt;  8 5, 1                0.237             0.748</span>
<span class="co">#&gt;  9 5, 2                0.814             0.739</span>
<span class="co">#&gt; 10 5, 7                0.564             0.475</span>
<span class="co">#&gt; # ... with 16 more rows</span></code></pre></div>
<p>We can standardize the surface matrix height values by centering/scaling by desired functions (e.g., mean and standard deviation). Also, to apply frequency-domain techniques in comparing each cell and region, the missing values in each scan need to be replaced. These operations are performed in the <code>comparison_standardizeHeightValues</code> and <code>comparison_replaceMissingValues</code> functions.</p>
<p>Then, the <code>comparison_fft_ccf</code> function estimates the translations required to align the cell and region using the <a href="https://mathworld.wolfram.com/Cross-CorrelationTheorem.html" class="external-link">Cross-Correlation Theorem</a>. The <code>comparison_fft_ccf</code> function returns a data frame of 3 <code>x</code>, <code>y</code>, and <code>fft_ccf</code> values: the <img src="https://latex.codecogs.com/png.image?%5Cdpi%7B110%7D&amp;space;%5Cbg_white&amp;space;x%2Cy" title="x,y" alt="x,y"> estimated translation values at which the CCF<img src="https://latex.codecogs.com/png.image?%5Cdpi%7B110%7D&amp;space;%5Cbg_white&amp;space;_%5Cmax" title="_\max" alt="_\max"> value is attained between the cell and region. The <code><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">tidyr::unnest</a></code> function can unpack the data frame into 3 separate columns, if desired.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cellTibble</span> <span class="op">&lt;-</span> <span class="va">cellTibble</span>  <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cellHeightValues <span class="op">=</span> <span class="fu"><a href="reference/comparison_standardizeHeights.html">comparison_standardizeHeights</a></span><span class="op">(</span><span class="va">cellHeightValues</span><span class="op">)</span>,
         regionHeightValues <span class="op">=</span> <span class="fu"><a href="reference/comparison_standardizeHeights.html">comparison_standardizeHeights</a></span><span class="op">(</span><span class="va">regionHeightValues</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cellHeightValues_replaced <span class="op">=</span> <span class="fu"><a href="reference/comparison_replaceMissing.html">comparison_replaceMissing</a></span><span class="op">(</span><span class="va">cellHeightValues</span><span class="op">)</span>,
         regionHeightValues_replaced <span class="op">=</span> <span class="fu"><a href="reference/comparison_replaceMissing.html">comparison_replaceMissing</a></span><span class="op">(</span><span class="va">regionHeightValues</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>fft_ccf_df <span class="op">=</span> <span class="fu"><a href="reference/comparison_fft_ccf.html">comparison_fft_ccf</a></span><span class="op">(</span>cellHeightValues <span class="op">=</span> <span class="va">cellHeightValues_replaced</span>,
                                         regionHeightValues <span class="op">=</span> <span class="va">regionHeightValues_replaced</span><span class="op">)</span><span class="op">)</span>

<span class="va">cellTibble</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">unnest</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">fft_ccf_df</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">cellIndex</span>,<span class="va">fft_ccf</span>,<span class="va">x</span>,<span class="va">y</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 26 x 4</span>
<span class="co">#&gt;    cellIndex fft_ccf     x     y</span>
<span class="co">#&gt;    &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt;  1 1, 6        0.194    -8   -24</span>
<span class="co">#&gt;  2 2, 7        0.210    52    32</span>
<span class="co">#&gt;  3 3, 7        0.119   -29   -64</span>
<span class="co">#&gt;  4 3, 8        0.153     9    14</span>
<span class="co">#&gt;  5 4, 1        0.228     0   -58</span>
<span class="co">#&gt;  6 4, 7        0.120   -61   -39</span>
<span class="co">#&gt;  7 4, 8        0.135     5   -54</span>
<span class="co">#&gt;  8 5, 1        0.230   -14   -54</span>
<span class="co">#&gt;  9 5, 2        0.230    45    99</span>
<span class="co">#&gt; 10 5, 7        0.169    28    -5</span>
<span class="co">#&gt; # ... with 16 more rows</span></code></pre></div>
<p>Because so many missing values need to be replaced, the CCF<img src="https://latex.codecogs.com/png.image?%5Cdpi%7B110%7D&amp;space;%5Cbg_white&amp;space;_%7B%5Cmax%7D" title="_{\max}" alt="_{\max}"> value calculated in the <code>fft_ccf</code> column using frequency-domain techniques is not a very good similarity score (doesn’t differentiate matches from non-matches well). However, the <code>x</code> and <code>y</code> estimated translations are good estimates of the “true” translation values needed to align the cell and region. To calculate a more accurate similarity score, we can use the pairwise-complete correlation in which only pairs of non-missing pixels are considered in the correlation calculation. To calculate this the <code>comparison_alignedTargetCell</code> function takes the cell, region, and CCF-based alignment information and returns a matrix of the same dimension as the reference cell representing the sub-matrix of the target region that the cell aligned to. We can then calculate the pairwise-complete correlation as shown below.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cellTibble</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>alignedTargetCell <span class="op">=</span> <span class="fu"><a href="reference/comparison_alignedTargetCell.html">comparison_alignedTargetCell</a></span><span class="op">(</span>cellHeightValues <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">cellHeightValues</span>,
                                                                   regionHeightValues <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">regionHeightValues</span>,
                                                                   target <span class="op">=</span> <span class="va">fadul1.2_processed</span>,
                                                                   theta <span class="op">=</span> <span class="fl">0</span>,
                                                                   fft_ccf_df <span class="op">=</span> <span class="va">.data</span><span class="op">$</span><span class="va">fft_ccf_df</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>pairwiseCompCor <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2_dbl</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">cellHeightValues</span>,<span class="va">.data</span><span class="op">$</span><span class="va">alignedTargetCell</span>,
                                             <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">.x</span><span class="op">$</span><span class="va">surface.matrix</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">.y</span><span class="op">$</span><span class="va">surface.matrix</span><span class="op">)</span>,
                                                   use <span class="op">=</span> <span class="st">"pairwise.complete.obs"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">fft_ccf_df</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">cellIndex</span>,<span class="va">x</span>,<span class="va">y</span>,<span class="va">pairwiseCompCor</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 26 x 4</span>
<span class="co">#&gt;    cellIndex     x     y pairwiseCompCor</span>
<span class="co">#&gt;    &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;           &lt;dbl&gt;</span>
<span class="co">#&gt;  1 1, 6         -8   -24           0.486</span>
<span class="co">#&gt;  2 2, 7         52    32           0.423</span>
<span class="co">#&gt;  3 3, 7        -29   -64           0.567</span>
<span class="co">#&gt;  4 3, 8          9    14           0.449</span>
<span class="co">#&gt;  5 4, 1          0   -58           0.519</span>
<span class="co">#&gt;  6 4, 7        -61   -39           0.523</span>
<span class="co">#&gt;  7 4, 8          5   -54           0.314</span>
<span class="co">#&gt;  8 5, 1        -14   -54           0.490</span>
<span class="co">#&gt;  9 5, 2         45    99           0.532</span>
<span class="co">#&gt; 10 5, 7         28    -5           0.514</span>
<span class="co">#&gt; # ... with 16 more rows</span></code></pre></div>
<p>Finally, this entire comparison procedure is to be repeated over a number of rotations of the target scan. The entire cell-based comparison procedure is wrapped in the <code>comparison_allTogether</code> function. The resulting data frame below contains the features that are used in the decision-rule procedure</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">kmComparisonFeatures</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">30</span>,<span class="fl">30</span>,by <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,
                                       <span class="op">~</span> <span class="fu"><a href="reference/comparison_allTogether.html">comparison_allTogether</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">fadul1.1_processed</span>,
                                                                target <span class="op">=</span> <span class="va">fadul1.2_processed</span>,
                                                                
                                                                theta <span class="op">=</span> <span class="va">.</span>,
                                                                returnX3Ps <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>

<span class="va">kmComparisonFeatures</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">theta</span>,<span class="va">cellIndex</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 524 x 11</span>
<span class="co">#&gt;    cellIndex     x     y fft_ccf pairwiseCompCor theta refMissingCount</span>
<span class="co">#&gt;    &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;           &lt;dbl&gt; &lt;dbl&gt;           &lt;dbl&gt;</span>
<span class="co">#&gt;  1 3, 1        -26    37   0.381           0.713   -30            2829</span>
<span class="co">#&gt;  2 3, 7        -42   -62   0.147           0.549   -30            4428</span>
<span class="co">#&gt;  3 3, 8          0    -9   0.178           0.396   -30            2858</span>
<span class="co">#&gt;  4 4, 1        -12    35   0.295           0.754   -30            1666</span>
<span class="co">#&gt;  5 4, 7          0   110   0.234           0.640   -30            4479</span>
<span class="co">#&gt;  6 4, 8        -10   -26   0.175           0.598   -30            1427</span>
<span class="co">#&gt;  7 5, 1         -5    36   0.286           0.747   -30            1278</span>
<span class="co">#&gt;  8 5, 2         -2    32   0.154           0.746   -30            4338</span>
<span class="co">#&gt;  9 5, 7        -53   -38   0.135           0.440   -30            3004</span>
<span class="co">#&gt; 10 5, 8          0   -22   0.275           0.661   -30            1548</span>
<span class="co">#&gt; # ... with 514 more rows, and 4 more variables: targMissingCount &lt;dbl&gt;,</span>
<span class="co">#&gt; #   jointlyMissing &lt;dbl&gt;, cellHeightValues &lt;named list&gt;,</span>
<span class="co">#&gt; #   alignedTargetCell &lt;named list&gt;</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="decision-rule">Decision rule<a class="anchor" aria-label="anchor" href="#decision-rule"></a>
</h3>
<p>The decision rules described in <a href="https://tsapps.nist.gov/publication/get_pdf.cfm?pub_id=911193" class="external-link">Song (2013)</a> and <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4730689/pdf/jres.120.008.pdf" class="external-link">Tong et al. (2015)</a> are implemented via the <code>decision_*</code> functions. We refer to the two decision rules as the original method of <a href="https://tsapps.nist.gov/publication/get_pdf.cfm?pub_id=911193" class="external-link">Song (2013)</a> and the High CMC method, respectively. Considering the <code>kmComparisonFeatures</code> data frame returned above, we can interpret both of these decision rules as logic that separates “aberrant” from “homogeneous” similarity features. The two decision rules principally differ in how they define an homogeneity.</p>
<p>The original method of <a href="https://tsapps.nist.gov/publication/get_pdf.cfm?pub_id=911193" class="external-link">Song (2013)</a> considers only the similarity features at which the maximum correlation is attained for each cell across all rotations considered. Since there is ambiguity in exactly how the correlation is computed in the original methods, we will consider the features at which specifically the maximum <code>pairwiseCompCor</code> is attained (instead of using the <code>fft_ccf</code> column).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">kmComparisonFeatures</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cellIndex</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/top_n.html" class="external-link">top_n</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>,wt <span class="op">=</span> <span class="va">pairwiseCompCor</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 27 x 11</span>
<span class="co">#&gt; # Groups:   cellIndex [27]</span>
<span class="co">#&gt;    cellIndex     x     y fft_ccf pairwiseCompCor theta refMissingCount</span>
<span class="co">#&gt;    &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;           &lt;dbl&gt; &lt;dbl&gt;           &lt;dbl&gt;</span>
<span class="co">#&gt;  1 6, 6          2     6   0.193           0.688   -30            3958</span>
<span class="co">#&gt;  2 5, 2         -4    20   0.175           0.825   -27            4338</span>
<span class="co">#&gt;  3 7, 5          7     2   0.172           0.722   -27            1688</span>
<span class="co">#&gt;  4 8, 6          6    -2   0.269           0.650   -27            2874</span>
<span class="co">#&gt;  5 4, 1         -6    10   0.353           0.844   -24            1666</span>
<span class="co">#&gt;  6 4, 8         -7     2   0.190           0.661   -24            1427</span>
<span class="co">#&gt;  7 5, 1         -6    11   0.331           0.840   -24            1278</span>
<span class="co">#&gt;  8 5, 8         -6     3   0.248           0.745   -24            1548</span>
<span class="co">#&gt;  9 6, 7         -6     3   0.222           0.696   -24             313</span>
<span class="co">#&gt; 10 6, 8         -5     7   0.257           0.789   -24            2912</span>
<span class="co">#&gt; # ... with 17 more rows, and 4 more variables: targMissingCount &lt;dbl&gt;,</span>
<span class="co">#&gt; #   jointlyMissing &lt;dbl&gt;, cellHeightValues &lt;named list&gt;,</span>
<span class="co">#&gt; #   alignedTargetCell &lt;named list&gt;</span></code></pre></div>
<p>The above set of features can be thought of as the <code>x</code>, <code>y</code>, and <code>theta</code> “votes” that each cell most strongly “believes” to be the correct alignment of the entire scan. If a pair is truly matching, we would expect many of these votes to be similar to each other; indicating that there is an approximate consensus of the true alignment of the entire scan (at least, this is the assumption made in <a href="https://tsapps.nist.gov/publication/get_pdf.cfm?pub_id=911193" class="external-link">Song (2013)</a>). In <a href="https://tsapps.nist.gov/publication/get_pdf.cfm?pub_id=911193" class="external-link">Song (2013)</a>, the consensus is defined to be the median of the <code>x</code>, <code>y</code>, and <code>theta</code> values in this <code>topVotesPerCell</code> data frame. Cells that are deemed “close” to these consensus values and that have a “large” correlation value are declared Congruent Matching Cells (CMCs). Cells with <code>x</code>, <code>y</code>, and <code>theta</code> values that are within user-defined <img src="https://latex.codecogs.com/png.image?%5Cdpi%7B110%7D&amp;space;%5Cbg_white&amp;space;T_x" title="T_x" alt="T_x">, <img src="https://latex.codecogs.com/png.image?%5Cdpi%7B110%7D&amp;space;%5Cbg_white&amp;space;T_y" title="T_y" alt="T_y">, and <img src="https://latex.codecogs.com/png.image?%5Cdpi%7B110%7D&amp;space;%5Cbg_white&amp;space;T_%7B%5Ctheta%7D" title="T_{\theta}" alt="T_{\theta}"> thresholds of the consensus <code>x</code>, <code>y</code>, and <code>theta</code> values are considered “close.” If these cells also have a correlation greater than a user-defined <img src="https://latex.codecogs.com/png.image?%5Cdpi%7B110%7D&amp;space;%5Cbg_white&amp;space;T_%7B%5Ctext%7BCCF%7D%7D" title="T_{\text{CCF}}" alt="T_{\text{CCF}}"> threshold, then they are considered CMCs. Note that these thresholds are chosen entirely by experimentation in the CMC literature.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">kmComparison_originalCMCs</span> <span class="op">&lt;-</span> <span class="va">kmComparisonFeatures</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>originalMethodClassif <span class="op">=</span> <span class="fu"><a href="reference/decision_CMC.html">decision_CMC</a></span><span class="op">(</span>cellIndex <span class="op">=</span> <span class="va">cellIndex</span>,
                                              x <span class="op">=</span> <span class="va">x</span>,
                                              y <span class="op">=</span> <span class="va">y</span>,
                                              theta <span class="op">=</span> <span class="va">theta</span>,
                                              corr <span class="op">=</span> <span class="va">pairwiseCompCor</span>,
                                              xThresh <span class="op">=</span> <span class="fl">20</span>,
                                              yThresh <span class="op">=</span> <span class="fl">20</span>,
                                              thetaThresh <span class="op">=</span> <span class="fl">6</span>,
                                              corrThresh <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span><span class="op">)</span>

<span class="va">kmComparison_originalCMCs</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">originalMethodClassif</span> <span class="op">==</span> <span class="st">"CMC"</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 19 x 12</span>
<span class="co">#&gt;    cellIndex     x     y fft_ccf pairwiseCompCor theta refMissingCount</span>
<span class="co">#&gt;    &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;           &lt;dbl&gt; &lt;dbl&gt;           &lt;dbl&gt;</span>
<span class="co">#&gt;  1 5, 2         -4    20   0.175           0.825   -27            4338</span>
<span class="co">#&gt;  2 7, 5          7     2   0.172           0.722   -27            1688</span>
<span class="co">#&gt;  3 8, 6          6    -2   0.269           0.650   -27            2874</span>
<span class="co">#&gt;  4 4, 1         -6    10   0.353           0.844   -24            1666</span>
<span class="co">#&gt;  5 4, 8         -7     2   0.190           0.661   -24            1427</span>
<span class="co">#&gt;  6 5, 1         -6    11   0.331           0.840   -24            1278</span>
<span class="co">#&gt;  7 5, 8         -6     3   0.248           0.745   -24            1548</span>
<span class="co">#&gt;  8 6, 7         -6     3   0.222           0.696   -24             313</span>
<span class="co">#&gt;  9 6, 8         -5     7   0.257           0.789   -24            2912</span>
<span class="co">#&gt; 10 7, 3         -3     8   0.217           0.749   -24             412</span>
<span class="co">#&gt; 11 7, 6         -2     1   0.227           0.774   -24              43</span>
<span class="co">#&gt; 12 7, 7         -4     5   0.360           0.839   -24            1103</span>
<span class="co">#&gt; 13 3, 7         -4    17   0.177           0.748   -21            4428</span>
<span class="co">#&gt; 14 6, 1        -11     1   0.317           0.822   -21            2826</span>
<span class="co">#&gt; 15 6, 2         -6    -4   0.344           0.797   -21             852</span>
<span class="co">#&gt; 16 7, 2        -11    -1   0.312           0.738   -21            1048</span>
<span class="co">#&gt; 17 7, 4        -14     4   0.251           0.805   -21            2132</span>
<span class="co">#&gt; 18 8, 3         -9    -4   0.269           0.755   -21            2753</span>
<span class="co">#&gt; 19 3, 1          4    -9   0.514           0.874   -18            2829</span>
<span class="co">#&gt; # ... with 5 more variables: targMissingCount &lt;dbl&gt;, jointlyMissing &lt;dbl&gt;,</span>
<span class="co">#&gt; #   cellHeightValues &lt;named list&gt;, alignedTargetCell &lt;named list&gt;,</span>
<span class="co">#&gt; #   originalMethodClassif &lt;chr&gt;</span></code></pre></div>
<p>Many have pointed out that there tends to be many cell/region pairs that exhibit high correlation other than at the “true” rotation (theta) value.<br>
In particular, a cell/region pair may attain a very high correlation at the “true” theta value, yet attain its maximum correlation at a theta value far from the consensus theta value. The original method of <a href="https://tsapps.nist.gov/publication/get_pdf.cfm?pub_id=911193" class="external-link">Song (2013)</a> is quite sensitive to this behavior. The original method of <a href="https://tsapps.nist.gov/publication/get_pdf.cfm?pub_id=911193" class="external-link">Song (2013)</a> only considers the “top” vote of each cell/region pairing, so it is not sensitive to how that cell/region pairing behaves across multiple rotations.</p>
<p><a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4730689/pdf/jres.120.008.pdf" class="external-link">Tong et al. (2015)</a> propose a different decision rule procedure that considers the behavior of cell/region pairings across multiple rotations. This method would come to be called the High CMC method. The procedure involves computing a “CMC-<code>theta</code>” distribution where for each value of <code>theta</code>, the <code>x</code> and <code>y</code> values are compared to consensus <code>x</code> and <code>y</code> values (again, the median) and the correlation values to a minimum threshold. A cell is considered a “CMC candidate” (our language, not theirs) at a particular <code>theta</code> value if its <code>x</code> and <code>y</code> values are within <img src="https://latex.codecogs.com/png.image?%5Cdpi%7B110%7D&amp;space;%5Cbg_white&amp;space;T_x" title="T_x" alt="T_x">, <img src="https://latex.codecogs.com/png.image?%5Cdpi%7B110%7D&amp;space;%5Cbg_white&amp;space;T_y" title="T_y" alt="T_y"> thresholds of the consensus <code>x</code> and <code>y</code> values and the correlation is at least as larges as the <img src="https://latex.codecogs.com/png.image?%5Cdpi%7B110%7D&amp;space;%5Cbg_white&amp;space;T_%7B%5Ctext%7BCCF%7D%7D" title="T_{\text{CCF}}" alt="T_{\text{CCF}}"> threshold. This is similar to the original method of <a href="https://tsapps.nist.gov/publication/get_pdf.cfm?pub_id=911193" class="external-link">Song (2013)</a> except that it relaxes the requirement that the top <code>theta</code> value be close to a consensus. Continuing with the voting analogy, think of this as an <a href="https://en.wikipedia.org/wiki/Approval_voting" class="external-link">approval voting system</a> where each cell is allowed to vote for multiple <code>theta</code> values as long as the <code>x</code> and <code>y</code> votes are deemed close to the <code>theta</code>-specific <code>x</code>,<code>y</code> consensuses and the correlation values are sufficiently high.</p>
<p>The CMC-<code>theta</code> distribution consists of the “CMC candidates” at each value of <code>theta</code>. The assumption made in <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4730689/pdf/jres.120.008.pdf" class="external-link">Tong et al. (2015)</a> is that, for a truly matching cartridge case pair, a large number of CMC candidates should be concentrated around true <code>theta</code> alignment value. In their words, the CMC-<code>theta</code> distribution should exhibit a “prominent peak” close to the rotation at which the two cartridge cases actually align. Such a prominent peak should not occur for a non-match cartridge case pair.</p>
<p>The figure below shows an example of a CMC-<code>theta</code> distribution between Fadul 1-1 and Fadul 1-2 constructed using the <code>decision_highCMC_cmcThetaDistrib</code> function. We can clearly see that a mode is attained around -24 degrees.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">kmComparisonFeatures</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cmcThetaDistribClassif <span class="op">=</span> <span class="fu"><a href="reference/decision_highCMC_cmcThetaDistrib.html">decision_highCMC_cmcThetaDistrib</a></span><span class="op">(</span>cellIndex <span class="op">=</span> <span class="va">cellIndex</span>,
                                                                   x <span class="op">=</span> <span class="va">x</span>,
                                                                   y <span class="op">=</span> <span class="va">y</span>,
                                                                   theta <span class="op">=</span> <span class="va">theta</span>,
                                                                   corr <span class="op">=</span> <span class="va">pairwiseCompCor</span>,
                                                                   xThresh <span class="op">=</span> <span class="fl">20</span>,
                                                                   yThresh <span class="op">=</span> <span class="fl">20</span>,
                                                                   corrThresh <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cmcThetaDistribClassif</span> <span class="op">==</span> <span class="st">"CMC Candidate"</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">theta</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"count"</span>,
           alpha <span class="op">=</span> <span class="fl">.7</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"CMC Candidate Count"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-12-1.png" width="100%"></p>
<p>The next step of the High CMC method is to automatically determine if a mode (i.e., a “prominent peak”) exists in a CMC-<code>theta</code> distribution. If we find a mode, then there is evidence that a “true” rotation exists to align the two cartridge cases implying the cartridge cases must be matches (such is the logic employed in <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4730689/pdf/jres.120.008.pdf" class="external-link">Tong et al. (2015)</a>). To automatically identify a mode, <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4730689/pdf/jres.120.008.pdf" class="external-link">Tong et al. (2015)</a> propose determining the range of <code>theta</code> values with “high” CMC candidate counts (if this range is small, then there is likely a mode). They define a “high” CMC candidate count to be <img src="https://latex.codecogs.com/png.image?%5Cdpi%7B110%7D&amp;space;%5Cbg_white&amp;space;CMC_%7B%5Ctext%7Bhigh%7D%7D%20%5Cequiv%20CMC_%7B%5Cmax%7D%20-%20%5Ctau" title="CMC_{\text{high}} \equiv CMC_{\max} - \tau" alt="CMC_{\text{high}} \equiv CMC_{\max} - \tau"> where <img src="https://latex.codecogs.com/png.image?%5Cdpi%7B110%7D&amp;space;%5Cbg_white&amp;space;CMC_%7B%5Cmax%7D" title="CMC_{\max}" alt="CMC_{\max}"> is the maximum value attained in the CMC-<code>theta</code> distribution (17 in the plot shown above) and <img src="https://latex.codecogs.com/png.image?%5Cdpi%7B110%7D&amp;space;%5Cbg_white&amp;space;%5Ctau" title="\tau" alt="\tau"> is a user-defined constant (<a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4730689/pdf/jres.120.008.pdf" class="external-link">Tong et al. (2015)</a> use <img src="https://latex.codecogs.com/png.image?%5Cdpi%7B110%7D&amp;space;%5Cbg_white&amp;space;%5Ctau%20%3D%201" title="\tau = 1" alt="\tau = 1">). Any <code>theta</code> value with associated an associated CMC candidate count at least as large as <img src="https://latex.codecogs.com/png.image?%5Cdpi%7B110%7D&amp;space;%5Cbg_white&amp;space;CMC_%7B%5Ctext%7Bhigh%7D%7D" title="CMC_{\text{high}}" alt="CMC_{\text{high}}"> have a “high” CMC candidate count while any others have a “low” CMC candidate count.</p>
<p>The figure below shows the classification of <code>theta</code> values into “High” and “Low” CMC candidate count groups using the <code>decision_highCMC_identifyHighCMCThetas</code> function. The High CMC count threshold is shown as a dashed line at <img src="https://latex.codecogs.com/png.image?%5Cdpi%7B110%7D&amp;space;%5Cbg_white&amp;space;21%20-%201" title="21 - 1" alt="21 - 1"> CMCs.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">kmComparisonFeatures</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cmcThetaDistribClassif <span class="op">=</span> <span class="fu"><a href="reference/decision_highCMC_cmcThetaDistrib.html">decision_highCMC_cmcThetaDistrib</a></span><span class="op">(</span>cellIndex <span class="op">=</span> <span class="va">cellIndex</span>,
                                                                   x <span class="op">=</span> <span class="va">x</span>,
                                                                   y <span class="op">=</span> <span class="va">y</span>,
                                                                   theta <span class="op">=</span> <span class="va">theta</span>,
                                                                   corr <span class="op">=</span> <span class="va">pairwiseCompCor</span>,
                                                                   xThresh <span class="op">=</span> <span class="fl">20</span>,
                                                                   yThresh <span class="op">=</span> <span class="fl">20</span>,
                                                                   corrThresh <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="reference/decision_highCMC_identifyHighCMCThetas.html">decision_highCMC_identifyHighCMCThetas</a></span><span class="op">(</span>tau <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cmcThetaDistribClassif</span> <span class="op">==</span> <span class="st">"CMC Candidate"</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">theta</span>, fill <span class="op">=</span> <span class="va">thetaCMCIdentif</span><span class="op">)</span>,
           stat <span class="op">=</span> <span class="st">"count"</span>,
           alpha <span class="op">=</span> <span class="fl">.7</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">cmcCandidateCount</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>,
             linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>,<span class="st">"gray50"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"CMC Candidate Count"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-13-1.png" width="100%"></p>
<p>If the range of High CMC count <code>theta</code> values is less than the user-defined <img src="https://latex.codecogs.com/png.image?%5Cdpi%7B110%7D&amp;space;%5Cbg_white&amp;space;T_%7B%5Ctheta%7D" title="T_{\theta}" alt="T_{\theta}"> threshold, then <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4730689/pdf/jres.120.008.pdf" class="external-link">Tong et al. (2015)</a> classify all CMC candidates in the identified <code>theta</code> mode as actual CMCs.</p>
<p>The <code>decision_CMC</code> function classifies CMCs based on this High CMC criterion if a value for <code>tau</code> is given. Note that it internally calls the <code>decision_highCMC_cmcThetaDistrib</code> and <code>decision_highCMC_identifyHighCMCThetas</code> functions (although they are exported as diagnostic tools). A cell may be counted as a CMC for multiple <code>theta</code> values. In these cases, we will only consider the alignment values at which the cell attained its maximum CCF and was classified as a CMC. If the cartridge case pair “fails” the High CMC criterion (i.e., the range of High CMC candidate <code>theta</code> values is deemed too large), every cell will be classified as “non-CMC (failed)” under the High CMC method. When it comes to combining the CMCs from two comparison directions (cartridge case A vs. B and B vs. A), we must treat a cell classified as a non-CMC because the High CMC criterion failed differently from a cell classified as a non-CMC for which the High CMC criterion passed. <!-- [Tong et al. (2015)](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4730689/pdf/jres.120.008.pdf) propose using the CMC count determined under the original method of [Song (2013)](https://tsapps.nist.gov/publication/get_pdf.cfm?pub_id=911193) as a backup CMC count. --></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">kmComparison_highCMCs</span> <span class="op">&lt;-</span> <span class="va">kmComparisonFeatures</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>highCMCClassif <span class="op">=</span> <span class="fu"><a href="reference/decision_CMC.html">decision_CMC</a></span><span class="op">(</span>cellIndex <span class="op">=</span> <span class="va">cellIndex</span>,
                                       x <span class="op">=</span> <span class="va">x</span>,
                                       y <span class="op">=</span> <span class="va">y</span>,
                                       theta <span class="op">=</span> <span class="va">theta</span>,
                                       corr <span class="op">=</span> <span class="va">pairwiseCompCor</span>,
                                       xThresh <span class="op">=</span> <span class="fl">20</span>,
                                       yThresh <span class="op">=</span> <span class="fl">20</span>,
                                       thetaThresh <span class="op">=</span> <span class="fl">6</span>,
                                       corrThresh <span class="op">=</span> <span class="fl">.5</span>,
                                       tau <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="co">#Example of cells classified as CMCs and non-CMCs</span>
<span class="va">kmComparison_highCMCs</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">21</span><span class="op">:</span><span class="fl">35</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 15 x 12</span>
<span class="co">#&gt;    cellIndex     x     y fft_ccf pairwiseCompCor theta refMissingCount</span>
<span class="co">#&gt;    &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;           &lt;dbl&gt; &lt;dbl&gt;           &lt;dbl&gt;</span>
<span class="co">#&gt;  1 7, 7         12   -10   0.328           0.750   -30            1103</span>
<span class="co">#&gt;  2 8, 3         27    14   0.252           0.694   -30            2753</span>
<span class="co">#&gt;  3 8, 4         37     4   0.251           0.644   -30            1385</span>
<span class="co">#&gt;  4 8, 5         22     1   0.226           0.542   -30            1399</span>
<span class="co">#&gt;  5 8, 6         18    -8   0.257           0.641   -30            2874</span>
<span class="co">#&gt;  6 2, 7        -24   -46   0.224           0.416   -27            2842</span>
<span class="co">#&gt;  7 3, 1        -18    26   0.409           0.733   -27            2829</span>
<span class="co">#&gt;  8 3, 7        -18    -7   0.168           0.657   -27            4428</span>
<span class="co">#&gt;  9 3, 8          5     4   0.177           0.395   -27            2858</span>
<span class="co">#&gt; 10 4, 1         -9    22   0.331           0.815   -27            1666</span>
<span class="co">#&gt; 11 4, 7          3   110   0.179           0.430   -27            4479</span>
<span class="co">#&gt; 12 4, 8         -9   -12   0.192           0.660   -27            1427</span>
<span class="co">#&gt; 13 5, 1         -5    24   0.311           0.809   -27            1278</span>
<span class="co">#&gt; 14 5, 2         -4    20   0.175           0.825   -27            4338</span>
<span class="co">#&gt; 15 5, 7        -58   -25   0.141           0.494   -27            3004</span>
<span class="co">#&gt; # ... with 5 more variables: targMissingCount &lt;dbl&gt;, jointlyMissing &lt;dbl&gt;,</span>
<span class="co">#&gt; #   cellHeightValues &lt;named list&gt;, alignedTargetCell &lt;named list&gt;,</span>
<span class="co">#&gt; #   highCMCClassif &lt;chr&gt;</span></code></pre></div>
<p>In summary: the <code>decison_CMC</code> function applies either the decision rules of the original method of <a href="https://tsapps.nist.gov/publication/get_pdf.cfm?pub_id=911193" class="external-link">Song (2013)</a> or the High CMC method of <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4730689/pdf/jres.120.008.pdf" class="external-link">Tong et al. (2015)</a>, depending on whether the user specifies a value for the High CMC threshold <code>tau</code>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">kmComparison_allCMCs</span> <span class="op">&lt;-</span> <span class="va">kmComparisonFeatures</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>originalMethodClassif <span class="op">=</span> <span class="fu"><a href="reference/decision_CMC.html">decision_CMC</a></span><span class="op">(</span>cellIndex <span class="op">=</span> <span class="va">cellIndex</span>,
                                              x <span class="op">=</span> <span class="va">x</span>,
                                              y <span class="op">=</span> <span class="va">y</span>,
                                              theta <span class="op">=</span> <span class="va">theta</span>,
                                              corr <span class="op">=</span> <span class="va">pairwiseCompCor</span>,
                                              xThresh <span class="op">=</span> <span class="fl">20</span>,
                                              thetaThresh <span class="op">=</span> <span class="fl">6</span>,
                                              corrThresh <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>,
         highCMCClassif <span class="op">=</span> <span class="fu"><a href="reference/decision_CMC.html">decision_CMC</a></span><span class="op">(</span>cellIndex <span class="op">=</span> <span class="va">cellIndex</span>,
                                       x <span class="op">=</span> <span class="va">x</span>,
                                       y <span class="op">=</span> <span class="va">y</span>,
                                       theta <span class="op">=</span> <span class="va">theta</span>,
                                       corr <span class="op">=</span> <span class="va">pairwiseCompCor</span>,
                                       xThresh <span class="op">=</span> <span class="fl">20</span>,
                                       thetaThresh <span class="op">=</span> <span class="fl">6</span>,
                                       corrThresh <span class="op">=</span> <span class="fl">.5</span>,
                                       tau <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>

<span class="co">#Example of cells classified as CMC under 1 decision rule but not the other.</span>
<span class="va">kmComparison_allCMCs</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">21</span><span class="op">:</span><span class="fl">35</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 15 x 13</span>
<span class="co">#&gt;    cellIndex     x     y fft_ccf pairwiseCompCor theta refMissingCount</span>
<span class="co">#&gt;    &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;           &lt;dbl&gt; &lt;dbl&gt;           &lt;dbl&gt;</span>
<span class="co">#&gt;  1 7, 7         12   -10   0.328           0.750   -30            1103</span>
<span class="co">#&gt;  2 8, 3         27    14   0.252           0.694   -30            2753</span>
<span class="co">#&gt;  3 8, 4         37     4   0.251           0.644   -30            1385</span>
<span class="co">#&gt;  4 8, 5         22     1   0.226           0.542   -30            1399</span>
<span class="co">#&gt;  5 8, 6         18    -8   0.257           0.641   -30            2874</span>
<span class="co">#&gt;  6 2, 7        -24   -46   0.224           0.416   -27            2842</span>
<span class="co">#&gt;  7 3, 1        -18    26   0.409           0.733   -27            2829</span>
<span class="co">#&gt;  8 3, 7        -18    -7   0.168           0.657   -27            4428</span>
<span class="co">#&gt;  9 3, 8          5     4   0.177           0.395   -27            2858</span>
<span class="co">#&gt; 10 4, 1         -9    22   0.331           0.815   -27            1666</span>
<span class="co">#&gt; 11 4, 7          3   110   0.179           0.430   -27            4479</span>
<span class="co">#&gt; 12 4, 8         -9   -12   0.192           0.660   -27            1427</span>
<span class="co">#&gt; 13 5, 1         -5    24   0.311           0.809   -27            1278</span>
<span class="co">#&gt; 14 5, 2         -4    20   0.175           0.825   -27            4338</span>
<span class="co">#&gt; 15 5, 7        -58   -25   0.141           0.494   -27            3004</span>
<span class="co">#&gt; # ... with 6 more variables: targMissingCount &lt;dbl&gt;, jointlyMissing &lt;dbl&gt;,</span>
<span class="co">#&gt; #   cellHeightValues &lt;named list&gt;, alignedTargetCell &lt;named list&gt;,</span>
<span class="co">#&gt; #   originalMethodClassif &lt;chr&gt;, highCMCClassif &lt;chr&gt;</span></code></pre></div>
<p>The set of CMCs computed above are based on assuming Fadul 1-1 as the reference scan and Fadul 1-2 as the target scan. <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4730689/pdf/jres.120.008.pdf" class="external-link">Tong et al. (2015)</a> propose performing the cell-based comparison and decision rule procedures with the roles reversed and combining the results. They indicate that if the High CMC method fails to identify a <code>theta</code> mode in the CMC-<code>theta</code> distribution, then the minimum of the two CMC counts computed under the original method of <a href="https://tsapps.nist.gov/publication/get_pdf.cfm?pub_id=911193" class="external-link">Song (2013)</a> should be used as the CMC count (although they don’t detail how to proceed if a <code>theta</code> mode is identified in only one of the two comparisons).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#Compare using Fadul 1-2 as reference and Fadul 1-1 as target</span>
<span class="va">kmComparisonFeatures_rev</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dfr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">30</span>,<span class="fl">30</span>,by <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,
                                           <span class="op">~</span> <span class="fu"><a href="reference/comparison_allTogether.html">comparison_allTogether</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">fadul1.2_processed</span>,
                                                                    target <span class="op">=</span> <span class="va">fadul1.1_processed</span>,
                                                                    theta <span class="op">=</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span>

<span class="va">kmComparison_allCMCs_rev</span> <span class="op">&lt;-</span> <span class="va">kmComparisonFeatures_rev</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>originalMethodClassif <span class="op">=</span> <span class="fu"><a href="reference/decision_CMC.html">decision_CMC</a></span><span class="op">(</span>cellIndex <span class="op">=</span> <span class="va">cellIndex</span>,
                                              x <span class="op">=</span> <span class="va">x</span>,
                                              y <span class="op">=</span> <span class="va">y</span>,
                                              theta <span class="op">=</span> <span class="va">theta</span>,
                                              corr <span class="op">=</span> <span class="va">pairwiseCompCor</span>,
                                              xThresh <span class="op">=</span> <span class="fl">20</span>,
                                              thetaThresh <span class="op">=</span> <span class="fl">6</span>,
                                              corrThresh <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>,
         highCMCClassif <span class="op">=</span> <span class="fu"><a href="reference/decision_CMC.html">decision_CMC</a></span><span class="op">(</span>cellIndex <span class="op">=</span> <span class="va">cellIndex</span>,
                                       x <span class="op">=</span> <span class="va">x</span>,
                                       y <span class="op">=</span> <span class="va">y</span>,
                                       theta <span class="op">=</span> <span class="va">theta</span>,
                                       corr <span class="op">=</span> <span class="va">pairwiseCompCor</span>,
                                       xThresh <span class="op">=</span> <span class="fl">20</span>,
                                       thetaThresh <span class="op">=</span> <span class="fl">6</span>,
                                       corrThresh <span class="op">=</span> <span class="fl">.5</span>,
                                       tau <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The logic required to combine the results in <code>kmComparison_allCMCs</code> and <code>kmComparison_allCMCs_rev</code> can get a little complicated (although entirely doable using <code>dplyr</code> and other <code>tidyverse</code> functions). The user must decide precisely how results from both directions are to be combined. For example, if one direction fails the High CMC criterion yet the other passes, should we treat this as if <em>both</em> directions failed? Will you only count the CMCs in the direction that passed? We have found the best option to be treating a failure in one direction as a failure in both directions – such cartridge case pairs would then be assigned the minimum of the two CMC counts determined under the original method of <a href="https://tsapps.nist.gov/publication/get_pdf.cfm?pub_id=911193" class="external-link">Song (2013)</a>. The <code>decision_combineDirections</code> function implements the logic to combine the two sets of results, assuming the data frame contains columns named <code>originalMethodClassif</code> and <code>highCMCClassif</code> (as defined above).</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/decision_combineDirections.html">decision_combineDirections</a></span><span class="op">(</span><span class="va">kmComparison_allCMCs</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
                             <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cellHeightValues</span>,<span class="va">alignedTargetCell</span><span class="op">)</span><span class="op">)</span>,
                           <span class="va">kmComparison_allCMCs_rev</span><span class="op">)</span>
<span class="co">#&gt; $originalMethodCMCs</span>
<span class="co">#&gt; $originalMethodCMCs[[1]]</span>
<span class="co">#&gt; # A tibble: 19 x 10</span>
<span class="co">#&gt;    cellIndex     x     y fft_ccf pairwiseCompCor theta refMissingCount</span>
<span class="co">#&gt;    &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;           &lt;dbl&gt; &lt;dbl&gt;           &lt;dbl&gt;</span>
<span class="co">#&gt;  1 5, 2         -4    20   0.175           0.825   -27            4338</span>
<span class="co">#&gt;  2 7, 5          7     2   0.172           0.722   -27            1688</span>
<span class="co">#&gt;  3 8, 6          6    -2   0.269           0.650   -27            2874</span>
<span class="co">#&gt;  4 4, 1         -6    10   0.353           0.844   -24            1666</span>
<span class="co">#&gt;  5 4, 8         -7     2   0.190           0.661   -24            1427</span>
<span class="co">#&gt;  6 5, 1         -6    11   0.331           0.840   -24            1278</span>
<span class="co">#&gt;  7 5, 8         -6     3   0.248           0.745   -24            1548</span>
<span class="co">#&gt;  8 6, 7         -6     3   0.222           0.696   -24             313</span>
<span class="co">#&gt;  9 6, 8         -5     7   0.257           0.789   -24            2912</span>
<span class="co">#&gt; 10 7, 3         -3     8   0.217           0.749   -24             412</span>
<span class="co">#&gt; 11 7, 6         -2     1   0.227           0.774   -24              43</span>
<span class="co">#&gt; 12 7, 7         -4     5   0.360           0.839   -24            1103</span>
<span class="co">#&gt; 13 3, 7         -4    17   0.177           0.748   -21            4428</span>
<span class="co">#&gt; 14 6, 1        -11     1   0.317           0.822   -21            2826</span>
<span class="co">#&gt; 15 6, 2         -6    -4   0.344           0.797   -21             852</span>
<span class="co">#&gt; 16 7, 2        -11    -1   0.312           0.738   -21            1048</span>
<span class="co">#&gt; 17 7, 4        -14     4   0.251           0.805   -21            2132</span>
<span class="co">#&gt; 18 8, 3         -9    -4   0.269           0.755   -21            2753</span>
<span class="co">#&gt; 19 3, 1          4    -9   0.514           0.874   -18            2829</span>
<span class="co">#&gt; # ... with 3 more variables: targMissingCount &lt;dbl&gt;, jointlyMissing &lt;dbl&gt;,</span>
<span class="co">#&gt; #   direction &lt;chr&gt;</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $originalMethodCMCs[[2]]</span>
<span class="co">#&gt; # A tibble: 19 x 10</span>
<span class="co">#&gt;    cellIndex     x     y fft_ccf pairwiseCompCor theta refMissingCount</span>
<span class="co">#&gt;    &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;           &lt;dbl&gt; &lt;dbl&gt;           &lt;dbl&gt;</span>
<span class="co">#&gt;  1 3, 8         -1   -19   0.230           0.652    21            2583</span>
<span class="co">#&gt;  2 4, 1          0    -4   0.550           0.884    21            3009</span>
<span class="co">#&gt;  3 7, 2          8    -3   0.403           0.801    21             945</span>
<span class="co">#&gt;  4 7, 7         10   -13   0.219           0.569    21             979</span>
<span class="co">#&gt;  5 1, 6         10    -8   0.168           0.665    24            3104</span>
<span class="co">#&gt;  6 2, 7          6    -8   0.216           0.669    24            1298</span>
<span class="co">#&gt;  7 4, 8          3    -8   0.286           0.776    24            1206</span>
<span class="co">#&gt;  8 5, 1          1   -14   0.356           0.833    24            1746</span>
<span class="co">#&gt;  9 5, 8          3    -9   0.324           0.822    24            1160</span>
<span class="co">#&gt; 10 6, 2          2   -12   0.293           0.788    24            1802</span>
<span class="co">#&gt; 11 6, 7          0    -2   0.259           0.665    24               0</span>
<span class="co">#&gt; 12 7, 3          1   -12   0.369           0.878    24             655</span>
<span class="co">#&gt; 13 7, 5          0    -9   0.264           0.795    24            1403</span>
<span class="co">#&gt; 14 7, 6          1    -8   0.197           0.634    24               1</span>
<span class="co">#&gt; 15 8, 4         -2    -9   0.282           0.796    24            1256</span>
<span class="co">#&gt; 16 3, 7         12     7   0.118           0.676    27            2359</span>
<span class="co">#&gt; 17 6, 1         -8   -24   0.268           0.789    27            2698</span>
<span class="co">#&gt; 18 6, 6         -9    -3   0.137           0.704    27            2673</span>
<span class="co">#&gt; 19 7, 4        -12    -9   0.145           0.714    27            2427</span>
<span class="co">#&gt; # ... with 3 more variables: targMissingCount &lt;dbl&gt;, jointlyMissing &lt;dbl&gt;,</span>
<span class="co">#&gt; #   direction &lt;chr&gt;</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $highCMCs</span>
<span class="co">#&gt; # A tibble: 19 x 10</span>
<span class="co">#&gt;    cellIndex     x     y fft_ccf pairwiseCompCor theta refMissingCount</span>
<span class="co">#&gt;    &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;           &lt;dbl&gt; &lt;dbl&gt;           &lt;dbl&gt;</span>
<span class="co">#&gt;  1 5, 2         -4    20   0.175           0.825   -27            4338</span>
<span class="co">#&gt;  2 7, 5          7     2   0.172           0.722   -27            1688</span>
<span class="co">#&gt;  3 8, 6          6    -2   0.269           0.650   -27            2874</span>
<span class="co">#&gt;  4 4, 1         -6    10   0.353           0.844   -24            1666</span>
<span class="co">#&gt;  5 4, 8         -7     2   0.190           0.661   -24            1427</span>
<span class="co">#&gt;  6 5, 1         -6    11   0.331           0.840   -24            1278</span>
<span class="co">#&gt;  7 5, 8         -6     3   0.248           0.745   -24            1548</span>
<span class="co">#&gt;  8 6, 7         -6     3   0.222           0.696   -24             313</span>
<span class="co">#&gt;  9 6, 8         -5     7   0.257           0.789   -24            2912</span>
<span class="co">#&gt; 10 7, 3         -3     8   0.217           0.749   -24             412</span>
<span class="co">#&gt; 11 7, 6         -2     1   0.227           0.774   -24              43</span>
<span class="co">#&gt; 12 7, 7         -4     5   0.360           0.839   -24            1103</span>
<span class="co">#&gt; 13 3, 7         -4    17   0.177           0.748   -21            4428</span>
<span class="co">#&gt; 14 6, 1        -11     1   0.317           0.822   -21            2826</span>
<span class="co">#&gt; 15 6, 2         -6    -4   0.344           0.797   -21             852</span>
<span class="co">#&gt; 16 7, 2        -11    -1   0.312           0.738   -21            1048</span>
<span class="co">#&gt; 17 7, 4        -14     4   0.251           0.805   -21            2132</span>
<span class="co">#&gt; 18 8, 3         -9    -4   0.269           0.755   -21            2753</span>
<span class="co">#&gt; 19 3, 1          4    -9   0.514           0.874   -18            2829</span>
<span class="co">#&gt; # ... with 3 more variables: targMissingCount &lt;dbl&gt;, jointlyMissing &lt;dbl&gt;,</span>
<span class="co">#&gt; #   direction &lt;chr&gt;</span></code></pre></div>
<p>The final step is to decide whether the number of CMCs computed under your preferred method is large enough to declare the cartridge case a match. <a href="https://tsapps.nist.gov/publication/get_pdf.cfm?pub_id=911193" class="external-link">Song (2013)</a> originally proposed using a CMC count equal to 6 as the decision boundary (i.e., classify “match” if CMC count is greater than or equal to 6). This has been shown to not generalize to other proposed methods and data sets (see, e.g., <a href="https://www.sciencedirect.com/science/article/pii/S0379073817303420?via%3Dihub" class="external-link">Chen et al. (2017)</a>). A more principled approach to choosing the CMC count has not yet been described.</p>
<p>Finally, we can visualize the regions of the scan identified as CMCs.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="reference/cmcPlot.html">cmcPlot</a></span><span class="op">(</span>reference <span class="op">=</span> <span class="va">fadul1.1_processed</span>,
                    target  <span class="op">=</span> <span class="va">fadul1.2_processed</span>,
                    cmcClassifs <span class="op">=</span> <span class="va">kmComparisonFeatures</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>originalMethodClassif <span class="op">=</span> <span class="fu"><a href="reference/decision_CMC.html">decision_CMC</a></span><span class="op">(</span>cellIndex <span class="op">=</span> <span class="va">cellIndex</span>,
                                              x <span class="op">=</span> <span class="va">x</span>,
                                              y <span class="op">=</span> <span class="va">y</span>,
                                              theta <span class="op">=</span> <span class="va">theta</span>,
                                              corr <span class="op">=</span> <span class="va">pairwiseCompCor</span>,
                                              xThresh <span class="op">=</span> <span class="fl">20</span>,
                                              thetaThresh <span class="op">=</span> <span class="fl">6</span>,
                                              corrThresh <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cellIndex</span><span class="op">)</span> <span class="op"><a href="reference/pipe.html">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">pairwiseCompCor</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">pairwiseCompCor</span><span class="op">)</span><span class="op">)</span>,
                    cmcCol <span class="op">=</span> <span class="st">"originalMethodClassif"</span><span class="op">)</span>
<span class="co">#&gt; Warning: Raster pixels are placed at uneven vertical intervals and will be</span>
<span class="co">#&gt; shifted. Consider using geom_tile() instead.</span></code></pre></div>
<p><img src="reference/figures/README-unnamed-chunk-18-1.png" width="100%"></p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://cloud.r-project.org/package=cmcR" class="external-link">View on CRAN</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li>GPL (&gt;= 3)</li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing cmcR</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Joe Zemmels <br><small class="roles"> Author, maintainer </small>  </li>
<li>Heike Hofmann <br><small class="roles"> Author </small>  </li>
<li>Susan VanderPlas <br><small class="roles"> Author </small>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://app.codecov.io/gh/CSAFE-ISU/cmcR?branch=master/" class="external-link"><img src="https://codecov.io/gh/CSAFE-ISU/cmcR/branch/master/graph/badge.svg" alt="Codecov test coverage"></a></li>
<li><a href="https://github.com/CSAFE-ISU/cmcR/actions/" class="external-link"><img src="https://github.com/CSAFE-ISU/cmcR/workflows/R-CMD-check/badge.svg" alt="R build status"></a></li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Joe Zemmels, Heike Hofmann, Susan VanderPlas.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
